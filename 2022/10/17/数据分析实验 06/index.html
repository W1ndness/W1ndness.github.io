<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha256-no0c5ccDODBwp+9hSmV5VvPpKwHCpbVzXHexIkupM6U=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" integrity="sha256-a5YRB27CcBwBFcT5EF/f3E4vzIqyHrSR878nseNYw64=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.leolang.top","root":"/","images":"/images","scheme":"Gemini","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":true,"lazyload":false,"nav":null,"activeClass":"changyan"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="数据分析实验 06 前言 本文对于 Kaggle 上的 Titanic 数据集进行了二分类任务的训练，分别使用了常规机器学习方法和 AutoML 方法。对于常规机器学习方法，实验过程中通过探索性数据分析、数据清洗、特征工程、模型选择、模型训练、模型调优几个过程，最终选择了 XGBoost 作为分类器进行预测，在验证集上达到了超过 \(90\%\) 的准确率。而通过 AutoGluon 框架进行的">
<meta property="og:type" content="article">
<meta property="og:title" content="数据分析实验 06">
<meta property="og:url" content="https://www.leolang.top/2022/10/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2006/index.html">
<meta property="og:site_name" content="W1ndness的技术栈">
<meta property="og:description" content="数据分析实验 06 前言 本文对于 Kaggle 上的 Titanic 数据集进行了二分类任务的训练，分别使用了常规机器学习方法和 AutoML 方法。对于常规机器学习方法，实验过程中通过探索性数据分析、数据清洗、特征工程、模型选择、模型训练、模型调优几个过程，最终选择了 XGBoost 作为分类器进行预测，在验证集上达到了超过 \(90\%\) 的准确率。而通过 AutoGluon 框架进行的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/view.png">
<meta property="article:published_time" content="2022-10-16T16:00:00.000Z">
<meta property="article:modified_time" content="2022-10-17T09:03:28.995Z">
<meta property="article:author" content="LeoLang">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Data Analysis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/view.png">


<link rel="canonical" href="https://www.leolang.top/2022/10/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2006/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.leolang.top/2022/10/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2006/","path":"2022/10/17/数据分析实验 06/","title":"数据分析实验 06"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>数据分析实验 06 | W1ndness的技术栈</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="W1ndness的技术栈" type="application/rss+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">W1ndness的技术栈</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Based on Hexo-NexT</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">72</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">24</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">54</span></a></li>
        <li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C-06"><span class="nav-text">数据分析实验 06</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="nav-text">0 写在前面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="nav-text">1 实验环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E9%87%8D%E8%BF%B0%E5%8F%8A%E5%88%86%E6%9E%90"><span class="nav-text">2 问题重述及分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE"><span class="nav-text">3 准备数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE"><span class="nav-text">3.1 查看数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E7%AD%BE%E5%B9%B3%E8%A1%A1%E5%BA%A6"><span class="nav-text">3.2 标签平衡度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%BE%81%E5%88%86%E5%B8%83"><span class="nav-text">3.3 特征分布</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E5%80%BC%E6%83%85%E5%86%B5"><span class="nav-text">3.4 空值情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E5%80%BC%E5%A1%AB%E5%85%85"><span class="nav-text">3.5 空值填充</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%96%B0%E7%89%B9%E5%BE%81"><span class="nav-text">3.6 构造新特征</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A2%E7%B4%A2%E7%89%B9%E5%BE%81%E5%92%8C%E5%B9%B8%E5%AD%98%E7%9A%84%E5%85%B3%E7%B3%BB%E5%BC%BA%E5%BC%B1"><span class="nav-text">3.7 探索特征和幸存的关系强弱</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E4%B8%80%E5%B1%9E%E6%80%A7%E5%92%8C%E5%B9%B8%E5%AD%98%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">3.7.1 单一属性和幸存的关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%89%E7%AD%89%E7%BA%A7%E5%88%86%E7%BB%84%E7%9A%84%E5%B1%9E%E6%80%A7%E5%92%8C%E5%B9%B8%E5%AD%98%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">3.7.2
按等级分组的属性和幸存的关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E4%B8%A4%E7%89%B9%E5%BE%81%E4%B9%8B%E9%97%B4%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%A7"><span class="nav-text">3.7.3 两两特征之间的相关性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%88%AB%E5%B1%9E%E6%80%A7%E5%A4%84%E7%90%86"><span class="nav-text">3.8 类别属性处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%AD%E7%BB%83%E9%9B%86%E6%B5%8B%E8%AF%95%E9%9B%86%E5%88%86%E5%89%B2"><span class="nav-text">3.9 训练集、测试集分割</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A6%BB%E7%BE%A4%E7%82%B9%E5%A4%84%E7%90%86"><span class="nav-text">3.10 离群点处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%B3%E8%A1%A1%E6%A0%87%E7%AD%BE"><span class="nav-text">3.11 平衡标签</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9%E5%92%8C%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83"><span class="nav-text">4 模型选择和模型训练</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%8C%85%E5%B9%B6%E5%BB%BA%E7%AB%8B-pipeline"><span class="nav-text">4.1 导包并建立 Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83"><span class="nav-text">4.2 开始训练</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E8%B0%83%E4%BC%98"><span class="nav-text">5 模型调优</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E7%BB%93%E6%9E%9C%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-text">6 模型结果可视化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%B1%BB%E7%BB%93%E6%9E%9C%E6%8A%A5%E5%91%8A"><span class="nav-text">6.1 分类结果报告</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B7%E6%B7%86%E7%9F%A9%E9%98%B5"><span class="nav-text">6.2 混淆矩阵</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%BE%81%E9%87%8D%E8%A6%81%E6%80%A7"><span class="nav-text">6.3 特征重要性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#xgboost-%E6%A0%91%E6%A8%A1%E5%9E%8B%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-text">6.4 XGBoost 树模型可视化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%90%E4%BA%A4%E7%BB%93%E6%9E%9C"><span class="nav-text">7 提交结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#automl-%E6%96%B9%E6%B3%95"><span class="nav-text">8 AutoML 方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">9 总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#references"><span class="nav-text">10 References</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="LeoLang"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">LeoLang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/w1ndness" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;w1ndness" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/imbaleo@163.com" title="E-Mail → imbaleo@163.com"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/W1ndness" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.leolang.top/2022/10/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2006/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="LeoLang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="W1ndness的技术栈">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          数据分析实验 06
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-17 00:00:00 / 修改时间：17:03:28" itemprop="dateCreated datePublished" datetime="2022-10-17T00:00:00+08:00">2022-10-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%9D%82%E6%96%87/" itemprop="url" rel="index"><span itemprop="name">学习杂文</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%9D%82%E6%96%87/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">数据分析实验</span></a>
        </span>
    </span>

  
    <span id="/2022/10/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2006/" class="post-meta-item leancloud_visitors" data-flag-title="数据分析实验 06" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2022/10/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2006/#SOHUCS" itemprop="discussionUrl">
        <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2022/10/17/数据分析实验 06/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>24k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>21 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="数据分析实验-06">数据分析实验 06</h1>
<h2 id="前言">前言</h2>
<p>本文对于 Kaggle 上的 Titanic
数据集进行了二分类任务的训练，分别使用了常规机器学习方法和 AutoML
方法。对于常规机器学习方法，实验过程中通过探索性数据分析、数据清洗、特征工程、模型选择、模型训练、模型调优几个过程，最终选择了
XGBoost 作为分类器进行预测，在验证集上达到了超过 <span
class="math inline">\(90\%\)</span> 的准确率。而通过 AutoGluon
框架进行的 AutoML 方法，在框架通过 NAS
算法进行模型搜索和自动调参后，准确率达到了接近 <span
class="math inline">\(90\%\)</span> 。常规机器学习方法和 AutoML
方法在最终的结果提交上都取得了 0.77 左右的分数。</p>
<span id="more"></span>
<h2 id="写在前面">0 写在前面</h2>
<p>本次实验出自 Kaggle 的一个十分经典的比赛，<strong>Titanic - Machine
Learning from Disaster</strong> ，链接在 <a
target="_blank" rel="noopener" href="https://www.kaggle.com/competitions/titanic">Titanic - Machine
Learning from Disaster | Kaggle</a> 。这是一个已经在 Kaggle
上变为周期滚榜且 100% 开放公榜的比赛。</p>
<p>所以，本次实验仍然依托与 Kaggle 平台进行。你可以在以下两个 Kaggle
notebook 中看到我的代码：</p>
<ul>
<li>AutoML 版本：<a
target="_blank" rel="noopener" href="https://www.kaggle.com/code/w1ndness/titanic-automl">Titanic-autoML
| Kaggle</a></li>
<li>常规机器学习方法版本：<a
target="_blank" rel="noopener" href="https://www.kaggle.com/code/w1ndness/titanic-contest">Titanic
Contest | Kaggle</a></li>
</ul>
<p>这次实验本质上是一个对于表格数据 （Tabular
Data）的二分类问题，提高模型准确率可以使用很多方法，其中最重要的应当是特征工程（Feature
Engineering），本文也会着重对于特征工程部分进行讲述。</p>
<p>在参考过很多比赛的博客之后，我认为对于这种工作的一般步骤如下：</p>
<ol type="1">
<li><p>探索性数据分析（EDA, Exploratory Data Analysis）</p>
<p>探索性数据分析即观察数据的分布、统计量及相关性。通过 EDA
的过程，可以大致了解数据的分布情况，为之后的数据清洗和特征工程进行指导。</p></li>
<li><p>数据清洗、数据预处理</p>
<p>进行数据清洗和数据预处理的相关工作，包括但不限于空值填充、部分数据的删除、离群点剔除等等。数据清洗的工作可以和探索性数据分析同时进行。</p></li>
<li><p>特征工程</p>
<p>根据被清洗后的数据和 EDA
中观察到的一些特点，对当前的数据做一定的处理，或是提取出某些新的特征，从而使得某些特征更加明显，或是产生某些很明显对于标签贡献很大的新特征。</p></li>
<li><p>数据挖掘、模型的选择和训练</p>
<p>对进行过特征工程的数据使用机器学习、深度学习等方法，根据特定的下游任务进行数据挖掘工作。根据任务的不同，选择针对该任务的一系列的模型进行初步训练，根据某些评价指标，挑选出表现较好的几个模型。</p></li>
<li><p>模型调优</p>
<p>根据模型选择的结果，使用网格搜索或其他的方式，对模型的参数进行调优，使得该模型尽可能的在当前问题上达到最优。</p></li>
<li><p>结果提交</p>
<p>根据训练好的模型，对测试集进行预测或其他任务，将得到的结果提交。</p></li>
</ol>
<p>本文也将遵循以上的框架，对我处理该问题的过程进行讲述。</p>
<h2 id="实验环境">1 实验环境</h2>
<p>本次实验中，常规机器学习方法采用了 Kaggle 预置的环境，并且启用了
GPU。而 autoML 方法采用的框架是来自 Amazon 的 autogluon。在 autoML
方法的配置中，首先使用 pip 下载 autogluon，这里使用了 mxnet
的后端（实际上也在下载过程中加载了 PyTorch）。</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">$ pip <span class="token function">install</span> <span class="token string">"mxnet&lt;2.0.0"</span>
$ pip <span class="token function">install</span> autogluon</code></pre>
<p>其他环境均不变。</p>
<h2 id="问题重述及分析">2 问题重述及分析</h2>
<p>这次报告中将问题重述和问题分析放到一个部分进行讲述。</p>
<p>《泰坦尼克号》这部电影最让大家熟识的是杰克和露丝凄美的爱情故事，但这背后却是现实中的一个悲剧故事：1912
年 4 月 10 日，号称
“世界工业史上的奇迹”的豪华客轮泰坦尼克号开始了它自己的处女航，从英国的南安普顿出发驶往美国纽约，但是在它的首航期间就撞上了冰山，最后沉没了。船上所有乘客和机组人员共
2224 名，最后只有 772 人存活下来，生还率只有
34.7%。这一悲剧传来，整个国际社会都为之震撼。这场耸人听闻的悲剧震惊了国际社会，并为船舶制定了更好的安全规定。</p>
<p>造成海难失事的原因之一是乘客和机组人员没有足够的救生艇。尽管幸存者有一些幸运因素，但有些人比其他人更容易生存，例如妇女，儿童和上流社会。</p>
<p>在这个挑战中，要求完成对哪些人可能存活的分析。特别是，要求运用机器学习工具来预测哪些乘客幸免于悲剧。</p>
<p>很明显的，这是一个对于表格数据的二分类问题，我们要求预测那些乘客死亡而哪些乘客是幸存者。针对分类问题，常用的机器学习方法有
K 近邻（KNN）、Logistic
回归、支持向量机（SVM）及一系列树模型（决策树、随机森林、LGBM、XGBoost等）。我们的目的是，根据所给的训练集训练一个分类器，使之能够根据所输入的特征对乘客的幸存与否进行判断。</p>
<h2 id="准备数据">3 准备数据</h2>
<p>这一部分将探索性数据分析、数据清洗及特征工程合并到一个部分进行讲述。这是考虑到在探索性数据分析的过程中，往往伴随着发现数据问题，并对数据进行清洗的过程，而在数据清洗的过程中，也可能存在着需要创建新的特征或对当前特征做处理，以使得数据填充的结果更加合理。</p>
<h3 id="查看数据">3.1 查看数据</h3>
<p>把后面要使用到的一些包进行导入：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> os
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns
<span class="token keyword">import</span> warnings
<span class="token operator">%</span>matploblib inline
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">'ignore'</span><span class="token punctuation">)</span></code></pre>
<p>使用 pandas 读入数据，并标记 ID 和标签。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'/kaggle/input/titanic/train.csv'</span><span class="token punctuation">)</span>
test_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'/kaggle/input/titanic/test.csv'</span><span class="token punctuation">)</span>
<span class="token builtin">id</span><span class="token punctuation">,</span> label <span class="token operator">=</span> <span class="token string">'PassengerId'</span><span class="token punctuation">,</span> <span class="token string">'Survived'</span></code></pre>
<p>首先，还是常规的查看一下数据前几行的大概形态和这些列的数据类型。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-15%2022.00.35.png"
alt="截屏2022-10-15 22.00.35" />
<figcaption aria-hidden="true">截屏2022-10-15 22.00.35</figcaption>
</figure>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-15%2022.01.02.png"
alt="截屏2022-10-15 22.01.02" />
<figcaption aria-hidden="true">截屏2022-10-15 22.01.02</figcaption>
</figure>
<p>由于训练集和测试集的列一致，那么这里就不展示查看测试集的结果了。我们看到
<code>Ticket</code>
列感觉上很杂乱无章，查看所给的数据字典，对于该列的描述是票号。第一直觉是这一列对于幸存与否没有什么实际的作用，只是一个单纯的文字描述。</p>
<p>之后来查看一下训练集和测试集的形状：</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> test_data<span class="token punctuation">.</span>shape</code></pre>
<p>返回的结果为：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">891</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">418</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="标签平衡度">3.2 标签平衡度</h3>
<p>之后，来查看一下训练集当中标签的平衡度。标签的平衡度对于后续分类器的训练有很大影响，如果标签极度不平衡，极端情况是所有标签几乎偏向一种类型，那么分类器训练的结果就会极度偏向那种类型，这显然是不合理的。对于标签不平衡的情况，我们需要在之后的处理中对标签进行平衡化。</p>
<p>通过 seaborn 绘制标签 <code>Survived</code>
不同取值数量的条形图：</p>
<pre class="language-python" data-language="python"><code class="language-python">sns<span class="token punctuation">.</span>countplot<span class="token punctuation">(</span>x<span class="token operator">=</span>train_data<span class="token punctuation">[</span><span class="token string">'Survived'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">"Survived"</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___8_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>在图中，可以看到两种标签的分布还是很不平衡的，大致的比例是 <span
class="math inline">\(\displaystyle\frac 3 4\)</span> 和 <span
class="math inline">\(\displaystyle\frac 1 4\)</span>
。这决定了我们后面需要做标签平衡化的处理。</p>
<h3 id="特征分布">3.3 特征分布</h3>
<p>之后，想要去观察一下类别属性（标称属性、二元属性）和数值属性的大致分布特点。通过
<code>sns.countplot()</code> 方法绘制取值数量的条形图。</p>
<pre class="language-python" data-language="python"><code class="language-python">sns<span class="token punctuation">.</span>countplot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'Pclass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>countplot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>countplot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'SibSp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>countplot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'Parch'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>countplot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'Embarked'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   </code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___4_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___5_1.png"
alt="img" /><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___6_1-20221015225714013.png"
alt="img" /><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___7_1-20221015225916413.png"
alt="img" /><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___8_1-20221015225917385.png"
alt="img" /></p>
<p>再观察一下数值属性的大致分布，通过 <code>sns.displot()</code>
方法绘制直方图，并显示核密度曲线。</p>
<pre class="language-python" data-language="python"><code class="language-python">sns<span class="token punctuation">.</span>displot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kde<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> rug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>displot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'Fare'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kde<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> rug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<p><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___9_1-20221015230010376.png"
alt="img" /><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___10_1.png"
alt="img" /></p>
<p>其余的属性其分布都比较分散，取值的差异性都比较大，这里就不进行展示了。</p>
<h3 id="空值情况">3.4 空值情况</h3>
<p>我们通过对表中空值计数的方式来查看表中目前的空值情况，也为了后续空值填充做处理。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">.</span>isna<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test_data<span class="token punctuation">.</span>isna<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre>
<p>得到的结果是：<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-15%2023.25.58.png"
alt="截屏2022-10-15 23.25.58" /></p>
<p>可以看到，两个表中都是描述船舱的 <code>Cabin</code>
字段空值最多，其次是年龄字段 <code>Age</code>
，两个表中也有几个零星的空值出现。再根据前面我们对 <code>Ticket</code>
列的观察，我们决定在之后的过程中将 <code>Cabin</code> 和
<code>Ticket</code> 列删除。</p>
<p>首先将训练集和测试集合并，以便在之后对数据的处理过程中能够一同处理，在最后训练时只需要重新将两数据集进行分裂即可。</p>
<p>将数据集合并，并查看合并后的数据集形状和列情况。</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>train_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> all_features<span class="token punctuation">.</span>columns</code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-16%2011.41.39.png"
alt="截屏2022-10-16 11.41.39" />
<figcaption aria-hidden="true">截屏2022-10-16 11.41.39</figcaption>
</figure>
<p>将 <code>Cabin</code> 和 <code>Ticket</code>
列进行丢弃，并查看表首五行的情况。</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features <span class="token operator">=</span> all_features<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Ticket'</span><span class="token punctuation">,</span> <span class="token string">'Cabin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-16%2011.42.42.png"
alt="截屏2022-10-16 11.42.42" />
<figcaption aria-hidden="true">截屏2022-10-16 11.42.42</figcaption>
</figure>
<h3 id="空值填充">3.5 空值填充</h3>
<p>在 3.4 的工作结束后，我们考虑对空值进行填充。根据 3.4
中对于空值的统计结果，我们需要填充的空值共有 <code>Age</code>
、<code>Embarked</code> 和 <code>Fare</code> 。由于
<code>Embarked</code> 和 <code>Fare</code>
的空值较少，我们这里就直接使用当前数据的统计特征对其进行填充。但
<code>Age</code>
列空值很多，单纯的用统计特征对其进行填充可能不太恰当，所以我们通过一些其他的特征对年龄进行推测。</p>
<p>对于 <code>Fare</code> ，我们使用其中位数进行填充，即</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features<span class="token punctuation">[</span><span class="token string">'Fare'</span><span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">[</span><span class="token string">'Fare'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Fare'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>median<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>而对于 <code>Embarked</code>
列，查看数据字典可知，该列的描述是登船港口。这里假设船票的三个等级在每个登船口的分布应当相似，所以这里我根据
<code>Pclass</code> 列的值进行分组，使用每组的众数对空值进行填充。</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features<span class="token punctuation">[</span><span class="token string">'Embarked'</span><span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Pclass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Embarked'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>
    <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Embarked'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>最后我们来填充 <code>Age</code>
列的空值。网上对于这一列的处理方法很多，最热门的方法一是通过一些列采用回归模型对于空值进行预测，二是生成新特征，通过一些特征的组合对数据进行分组，也就是按各个阶层、男女老少进行分组，从而将空值进行填充。</p>
<p>这里我使用的是第二种方法。首先，我们观察 <code>Name</code>
列，虽然这一列看起来是杂乱无章，但英语姓名当中都会存在着表示这个人身份、性别的一些部分，比如这里面有的
Mr. 、Mrs.
等。我们将名字以空格进行分割，查看一下这一部分的值的情况，并生成一个新的类别特征。这里我只截取了出现次数较多的几个值进行展示。</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features<span class="token punctuation">[</span><span class="token string">'Title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">[</span><span class="token string">'Name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">[</span><span class="token string">'Title'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-16%2013.23.14.png"
alt="截屏2022-10-16 13.23.14" />
<figcaption aria-hidden="true">截屏2022-10-16 13.23.14</figcaption>
</figure>
<p>由于除了前四个以外，后面的所有取值出现的次数都 <span
class="math inline">\(&lt;10\)</span>
，那么我们这里统一把后面的那些情况都归为一类。</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features<span class="token punctuation">[</span><span class="token string">'Title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">[</span><span class="token string">'Title'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>
    <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token keyword">if</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'Mr'</span><span class="token punctuation">,</span> <span class="token string">'Miss'</span><span class="token punctuation">,</span> <span class="token string">'Mrs'</span><span class="token punctuation">,</span> <span class="token string">'Master'</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token string">'None'</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">[</span><span class="token string">'Title'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-16%2013.25.15.png"
alt="截屏2022-10-16 13.25.15" />
<figcaption aria-hidden="true">截屏2022-10-16 13.25.15</figcaption>
</figure>
<p>之后，把 <code>Name</code> 一列去掉。</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features <span class="token operator">=</span> all_features<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>得到这一特征之后，我们就按照船票登记、身份和性别，将表中数据进行分组，取每一组当中的中位数对空值进行填充。</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Pclass'</span><span class="token punctuation">,</span> <span class="token string">'Title'</span><span class="token punctuation">,</span> <span class="token string">'Sex'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>
    <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>median<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>对于年龄这一特征的处理，我还尝试过按照年龄段进行分类，大致通过这样的方法实现：</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">35</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>
all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span></code></pre>
<p>但这种方式在实验过程中导致了最后准确率的下降，所以这里没有对年龄做进一步的处理。</p>
<p>整体处理结束后，目前得到的表大致是下面这样。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2011.37.28.png"
alt="截屏2022-10-17 11.37.28" />
<figcaption aria-hidden="true">截屏2022-10-17 11.37.28</figcaption>
</figure>
<h3 id="构造新特征">3.6 构造新特征</h3>
<p>在前面的过程中，我们已经构造了一个新特征 <code>Title</code>
。接下来，我们将根据家庭信息去再构造几个新特征。构造这些特征的理由是如果一家人的规模很大，那么可能儿童和妇女的生吞几率很大，反之如果上船的乘客是独自一人，那他由于不需要考虑其他人，它生存的几率也很大。所以，我们有必要去创建这样一个或一些对于幸存与否具有贡献的特征。我这里选择了根据
<code>SibSp</code> 和 <code>Parch</code>
去构建家庭总成员人数，并根据构造出来的家庭人数去判断这个乘客是否孤身一人。</p>
<p>定义一个家庭的总人数 <span class="math inline">\(Family\)</span> 等于
<span class="math display">\[
Family=SibSp+Parch+1
\]</span> 之后，根据 <span class="math inline">\(Family\)</span>
的值定义这名乘客是否孤身一人。定义特征 <span
class="math inline">\(Alone\)</span> 为 <span class="math display">\[
Alone=
\begin{cases}
True &amp; Family\le 1\\
False &amp; otherwise
\end{cases}
\]</span> 以上两个特征的创建通过以下代码实现：</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features<span class="token punctuation">[</span><span class="token string">'Family'</span><span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">[</span><span class="token string">'SibSp'</span><span class="token punctuation">]</span> <span class="token operator">+</span> all_features<span class="token punctuation">[</span><span class="token string">'Parch'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
all_features<span class="token punctuation">[</span><span class="token string">'Alone'</span><span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">[</span><span class="token string">'Family'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span></code></pre>
<h3 id="探索特征和幸存的关系强弱">3.7 探索特征和幸存的关系强弱</h3>
<p>我们这里采用两种方式来探索各个特征和乘客是否幸存的关系强弱。一是通过各种统计图表，二是通过相关性矩阵的热力图。</p>
<p>由于上面我们把幸存列给剔除了，这里我们重新生成一个拼接表。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_size <span class="token operator">=</span> train_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>all_features<span class="token punctuation">[</span><span class="token punctuation">:</span>train_size<span class="token punctuation">]</span><span class="token punctuation">,</span> train_data<span class="token punctuation">[</span><span class="token string">'Survived'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<h4 id="单一属性和幸存的关系">3.7.1 单一属性和幸存的关系</h4>
<p>第一，我们观察单一属性和幸存与否的关系。首先观察幸存与否和年龄分布的关系，分别通过直方图和核密度曲线进行观察。</p>
<pre class="language-python" data-language="python"><code class="language-python">sns<span class="token punctuation">.</span>displot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Age'</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> multiple<span class="token operator">=</span><span class="token string">'stack'</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___29_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<pre class="language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> sns<span class="token punctuation">.</span>FacetGrid<span class="token punctuation">(</span>df<span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> aspect<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>sns<span class="token punctuation">.</span>kdeplot<span class="token punctuation">,</span> <span class="token string">'Age'</span><span class="token punctuation">,</span> shade<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>xlim<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>add_legend<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___30_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>之后是几个数值属性的分布情况。</p>
<pre class="language-python" data-language="python"><code class="language-python">sns<span class="token punctuation">.</span>displot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'SibSp'</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> multiple<span class="token operator">=</span><span class="token string">'stack'</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>displot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Parch'</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> multiple<span class="token operator">=</span><span class="token string">'stack'</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>displot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Fare'</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> multiple<span class="token operator">=</span><span class="token string">'stack'</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>displot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Family'</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> multiple<span class="token operator">=</span><span class="token string">'stack'</span><span class="token punctuation">)</span></code></pre>
<p><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___31_1-20221017113821096.png"
alt="img" /><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___31_2.png"
alt="img" /></p>
<p><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___31_3-20221017113853643.png"
alt="img" /><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___31_4.png"
alt="img" /></p>
<p>之后，是几个类别属性的分布情况，通过柱状图展示。</p>
<pre class="language-python" data-language="python"><code class="language-python">fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Pclass'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Sex'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Embarked'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Alone'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___32_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<pre class="language-python" data-language="python"><code class="language-python">sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Title'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___33_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<h4 id="按等级分组的属性和幸存的关系">3.7.2
按等级分组的属性和幸存的关系</h4>
<p>从 3.7.1
中可以看到，对于一众多类别属性和数值属性，<code>Pclass</code>
随着其类别取值的不同，每一组中的生存率是一个单调的趋势，这就很突出的证明票的等级对幸存与否很重要。</p>
<p>之后我们想要去看一下，其他的一些属性在根据 <code>Pclass</code>
进行分组的情况下，对于幸存与否的重要程度。我们通过箱图的方式来展现这一问题，这里选取了
<code>Fare</code> 、<code>Age</code> 和 <code>Family</code>
三个属性进行观察。</p>
<pre class="language-python" data-language="python"><code class="language-python">fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>boxplot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Pclass'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Fare'</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Pclass vs Fare Survival Comparison'</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>violinplot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Pclass'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Age'</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Pclass vs Age Survival Comparison'</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>boxplot<span class="token punctuation">(</span>data<span class="token operator">=</span>df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Pclass'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Family'</span><span class="token punctuation">,</span> hue<span class="token operator">=</span><span class="token string">'Survived'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Pclass vs Family Survival Comparison'</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___34_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<h4 id="两两特征之间的相关性">3.7.3 两两特征之间的相关性</h4>
<p>为了衡量特征之间的相关性，我们用相关性矩阵来衡量，这里计算了特征之间的皮尔逊相关系数矩阵。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">correlation_heatmap</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _ <span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    colormap <span class="token operator">=</span> sns<span class="token punctuation">.</span>diverging_palette<span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> as_cmap<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    _ <span class="token operator">=</span> sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>
        df<span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        cmap <span class="token operator">=</span> colormap<span class="token punctuation">,</span>
        square<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
        cbar_kws<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'shrink'</span><span class="token punctuation">:</span><span class="token number">.9</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
        ax<span class="token operator">=</span>ax<span class="token punctuation">,</span>
        annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
        linewidths<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>vmax<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> linecolor<span class="token operator">=</span><span class="token string">'white'</span><span class="token punctuation">,</span>
        annot_kws<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'fontsize'</span><span class="token punctuation">:</span><span class="token number">12</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span>
    
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Pearson Correlation of Features'</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">)</span>

correlation_heatmap<span class="token punctuation">(</span>df<span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___36_0.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<h3 id="类别属性处理">3.8 类别属性处理</h3>
<p>这里主要涉及两步的处理，一是将二值属性转化为 01
编码形式，二是将多值分类属性转化为独热编码形式。</p>
<p>使用 sklearn 的 <code>LabelEncoder()</code> 将二值属性转化为 01
编码：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> LabelEncoder

encoder <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span> <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">[</span><span class="token string">'Alone'</span><span class="token punctuation">]</span> <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Alone'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>独热编码的转化有很多种方式，采用 <code>pd.get_dummies()</code>
方法应该是最为简单的。</p>
<pre class="language-python" data-language="python"><code class="language-python">categories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Pclass'</span><span class="token punctuation">,</span> <span class="token string">'Title'</span><span class="token punctuation">,</span> <span class="token string">'Embarked'</span><span class="token punctuation">]</span>
all_features <span class="token operator">=</span> pd<span class="token punctuation">.</span>get_dummies<span class="token punctuation">(</span>all_features<span class="token punctuation">,</span> columns<span class="token operator">=</span>categories<span class="token punctuation">)</span></code></pre>
<p>查看一下处理好的数据（表太长这里没法截全）：</p>
<pre class="language-python" data-language="python"><code class="language-python">all_features<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2011.40.09.png"
alt="截屏2022-10-17 11.40.09" />
<figcaption aria-hidden="true">截屏2022-10-17 11.40.09</figcaption>
</figure>
<h3 id="训练集测试集分割">3.9 训练集、测试集分割</h3>
<p>我们以上已经几乎完成了数据准备的过程，接下来我们要将数据还原回原来的训练集和测试集。通过原来训练数据的行数来确定如何分割当前的数据，之后通过切片的方式进行分割，并在训练集上将标签添加回去。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_size <span class="token operator">=</span> train_data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
y_train <span class="token operator">=</span> train_data<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">.</span>values
train_data <span class="token operator">=</span> all_features<span class="token punctuation">[</span><span class="token punctuation">:</span>train_size<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
test_data <span class="token operator">=</span> all_features<span class="token punctuation">[</span>train_size<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_data<span class="token punctuation">[</span><span class="token string">'Survived'</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_train
train_data<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> test_data<span class="token punctuation">.</span>shape</code></pre>
<p>得到输出的形状：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">891</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">418</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>训练集和数据集的行数和原来都一致，分割没有问题。</p>
<h3 id="离群点处理">3.10 离群点处理</h3>
<p>处理的倒数第二步是将训练集中的离群点进行剔除，这里我剔除了 <span
class="math inline">\(0.02\)</span> 的异常值。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> LocalOutlierFactor

lof <span class="token operator">=</span> LocalOutlierFactor<span class="token punctuation">(</span>contamination<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">)</span>
outliers <span class="token operator">=</span> lof<span class="token punctuation">.</span>fit_predict<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>
train_data <span class="token operator">=</span> train_data<span class="token punctuation">[</span>np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>outliers <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
train_data<span class="token punctuation">.</span>shape</code></pre>
<p>输出是：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span><span class="token number">873</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span></code></pre>
<p>可以看到，行数的确减少了。</p>
<h3 id="平衡标签">3.11 平衡标签</h3>
<p>整个数据准备过程的最后一步，我们对之前发现的标签不平衡的问题进行平衡化处理。</p>
<p>首先将数据集准备成能输入到模型里的形式：</p>
<pre class="language-python" data-language="python"><code class="language-python">X_train<span class="token punctuation">,</span> y_train <span class="token operator">=</span> train_data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> train_data<span class="token punctuation">[</span>label<span class="token punctuation">]</span>
X_test <span class="token operator">=</span> test_data</code></pre>
<p>得到 <code>X_train</code> 、<code>y_train</code> 和
<code>X_test</code> 。</p>
<p>这里使用 SMOTE 模型进行平衡化处理，实现的代码是：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> imblearn<span class="token punctuation">.</span>over_sampling <span class="token keyword">import</span> SMOTE

sns<span class="token punctuation">.</span>kdeplot<span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">)</span>
smote <span class="token operator">=</span> SMOTE<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
X_train<span class="token punctuation">,</span> y_train <span class="token operator">=</span> smote<span class="token punctuation">.</span>fit_resample<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>kdeplot<span class="token punctuation">(</span>y_train<span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___45_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>输出的图中给出了两条曲线，红色代表平衡前，蓝色代表平衡后。可以很明显的看到，蓝色曲线的两峰是在一条水平线上的。至此，我们的数据准备过程结束。</p>
<h2 id="模型选择和模型训练">4 模型选择和模型训练</h2>
<p>在这一部分中，我选择了十个模型进行训练。模型的信息如下表所示。</p>
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 16%" />
<col style="width: 21%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">模型名</th>
<th style="text-align: center;">所属包</th>
<th style="text-align: center;">包内类名</th>
<th style="text-align: center;">官方文档链接</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">高斯朴素贝叶斯</td>
<td style="text-align: center;">sklearn.navie_bayes</td>
<td style="text-align: center;">GaussianNB</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.naive_bayes.GaussianNB.html">sklearn.naive_bayes.GaussianNB
— scikit-learn 1.1.2 documentation</a></td>
</tr>
<tr class="even">
<td style="text-align: center;">K近邻</td>
<td style="text-align: center;">sklearn.neighbors</td>
<td style="text-align: center;">KNeighborsClassifier</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KNeighborsClassifier.html?highlight=kneighborsclassifier#sklearn.neighbors.KNeighborsClassifier">sklearn.neighbors.KNeighborsClassifier
— scikit-learn 1.1.2 documentation</a></td>
</tr>
<tr class="odd">
<td style="text-align: center;">随机森林</td>
<td style="text-align: center;">sklearn.ensemble</td>
<td style="text-align: center;">RandomForestClassifier</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html?highlight=randomforestclassifier#sklearn.ensemble.RandomForestClassifier">sklearn.ensemble.RandomForestClassifier
— scikit-learn 1.1.2 documentation</a></td>
</tr>
<tr class="even">
<td style="text-align: center;">决策树</td>
<td style="text-align: center;">sklearn.tree</td>
<td style="text-align: center;">DecisionTreeClassifier</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html?highlight=decisiontreeclassifier#sklearn.tree.DecisionTreeClassifier">sklearn.tree.DecisionTreeClassifier
— scikit-learn 1.1.2 documentation</a></td>
</tr>
<tr class="odd">
<td style="text-align: center;">XGBoost</td>
<td style="text-align: center;">xgboost</td>
<td style="text-align: center;">XGBClassifier</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://xgboost.readthedocs.io/en/latest/python/python_api.html#xgboost.XGBClassifier">Python
API Reference — xgboost 1.7.0-dev documentation</a></td>
</tr>
<tr class="even">
<td style="text-align: center;">Logistic回归</td>
<td style="text-align: center;">sklearn.linear_model</td>
<td style="text-align: center;">LogisticRegression</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html?highlight=logisticregression#sklearn.linear_model.LogisticRegression">sklearn.linear_model.LogisticRegression
— scikit-learn 1.1.2 documentation</a></td>
</tr>
<tr class="odd">
<td style="text-align: center;">LightGBM</td>
<td style="text-align: center;">lightgbm</td>
<td style="text-align: center;">LGBMClassifier</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://lightgbm.readthedocs.io/en/latest/pythonapi/lightgbm.LGBMClassifier.html#lightgbm.LGBMClassifier">lightgbm.LGBMClassifier
— LightGBM 3.3.2.99 documentation</a></td>
</tr>
<tr class="even">
<td style="text-align: center;">CatBoost</td>
<td style="text-align: center;">catboost</td>
<td style="text-align: center;">CatBoostClassifier</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://catboost.ai/en/docs/concepts/python-reference_catboostclassifier">Overview
- CatBoostClassifier | CatBoost</a></td>
</tr>
<tr class="odd">
<td style="text-align: center;">AdaBoost</td>
<td style="text-align: center;">sklearn.ensemble</td>
<td style="text-align: center;">GradientBoostingClassifier</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingClassifier.html?highlight=gradientboostingclassifier#sklearn.ensemble.GradientBoostingClassifier">sklearn.ensemble.GradientBoostingClassifier
— scikit-learn 1.1.2 documentation</a></td>
</tr>
<tr class="even">
<td style="text-align: center;">支持向量机</td>
<td style="text-align: center;">sklearn.svm</td>
<td style="text-align: center;">SVC</td>
<td style="text-align: center;"><a
target="_blank" rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.svm.SVC.html?highlight=svc#sklearn.svm.SVC">sklearn.svm.SVC
— scikit-learn 1.1.2 documentation</a></td>
</tr>
</tbody>
</table>
<p>以下也给出了以上列出的模型中较新模型的论文原文链接：</p>
<ul>
<li>XGBoost：<a
target="_blank" rel="noopener" href="https://arxiv.org/pdf/1603.02754.pdf">1603.02754.pdf
(arxiv.org)</a></li>
<li>LightGBM：<a
target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.5555/3294996.3295074">LightGBM |
Proceedings of the 31st International Conference on Neural Information
Processing Systems (acm.org)</a></li>
<li>CatBoost：<a
target="_blank" rel="noopener" href="https://arxiv.org/pdf/1706.09516.pdf">1706.09516.pdf
(arxiv.org)</a></li>
</ul>
<h3 id="导包并建立-pipeline">4.1 导包并建立 Pipeline</h3>
<p>首先导入下面要使用的所有模型。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>naive_bayes <span class="token keyword">import</span> GaussianNB
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>neighbors <span class="token keyword">import</span> KNeighborsClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LogisticRegression
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>tree <span class="token keyword">import</span> DecisionTreeClassifier
<span class="token keyword">from</span> xgboost <span class="token keyword">import</span> XGBClassifier
<span class="token keyword">from</span> lightgbm <span class="token keyword">import</span> LGBMClassifier
<span class="token keyword">from</span> catboost <span class="token keyword">import</span> CatBoostClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> AdaBoostClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> GradientBoostingClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>svm <span class="token keyword">import</span> SVC

<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> GridSearchCV<span class="token punctuation">,</span> cross_validate<span class="token punctuation">,</span> ShuffleSplit
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_absolute_error <span class="token keyword">as</span> MAE
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error <span class="token keyword">as</span> MSE
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> classification_report
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> confusion_matrix</code></pre>
<p>之后，我们使用 sklearn 提供的
Pipeline，创建以上表中十个模型的训练流水线。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>pipeline <span class="token keyword">import</span> Pipeline

gnb <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'GaussianNB'</span><span class="token punctuation">,</span> GaussianNB<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
knn <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'KNeighborsClassifier'</span><span class="token punctuation">,</span> KNeighborsClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
rf <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'RandomForestClassifier'</span><span class="token punctuation">,</span> RandomForestClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
dt <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'DecisionTreeClassifier'</span><span class="token punctuation">,</span> DecisionTreeClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
xgb <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'XGBClassifier'</span><span class="token punctuation">,</span> XGBClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
lgr <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'LogisticRegression'</span><span class="token punctuation">,</span> LogisticRegression<span class="token punctuation">(</span>solver<span class="token operator">=</span><span class="token string">'lbfgs'</span><span class="token punctuation">,</span> max_iter<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
lgbm <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'LGBMClassifier'</span><span class="token punctuation">,</span> LGBMClassifier<span class="token punctuation">(</span>objective<span class="token operator">=</span><span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
catb <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'CatBoostClassifier'</span><span class="token punctuation">,</span> CatBoostClassifier<span class="token punctuation">(</span>verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
adab <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'AdaBoostClassifier'</span><span class="token punctuation">,</span> GradientBoostingClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
svm <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'SVMClassifier'</span><span class="token punctuation">,</span> SVC<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>gnb<span class="token punctuation">,</span> knn<span class="token punctuation">,</span> rf<span class="token punctuation">,</span> dt<span class="token punctuation">,</span> xgb<span class="token punctuation">,</span> lgr<span class="token punctuation">,</span> lgbm<span class="token punctuation">,</span> catb<span class="token punctuation">,</span> adab<span class="token punctuation">,</span> svm<span class="token punctuation">]</span>
pipe_dict <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'GaussianNB'</span><span class="token punctuation">,</span> 
             <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'KNeighborsClassifier'</span><span class="token punctuation">,</span> 
             <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'RandomForestClassifier'</span><span class="token punctuation">,</span>
             <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'DecisionTreeClassifier'</span><span class="token punctuation">,</span>
             <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">'XGBClassifier'</span><span class="token punctuation">,</span> 
             <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">'LogisticRegression'</span><span class="token punctuation">,</span>
             <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">'LGBMClassifier'</span><span class="token punctuation">,</span> 
             <span class="token number">7</span><span class="token punctuation">:</span> <span class="token string">'CatBoostClassifier'</span><span class="token punctuation">,</span>
             <span class="token number">8</span><span class="token punctuation">:</span> <span class="token string">'AdaBoostClassifier'</span><span class="token punctuation">,</span>
             <span class="token number">9</span><span class="token punctuation">:</span> <span class="token string">'SVMClassifier'</span><span class="token punctuation">&#125;</span></code></pre>
<h3 id="开始训练">4.2 开始训练</h3>
<p>我这里采用的训练方式是，将原训练集以 <span
class="math inline">\(60\%\)</span> 和 <span
class="math inline">\(30\%\)</span> 的占比分割，并丢弃 <span
class="math inline">\(10\%\)</span>
的数据集，从而得到训练集和验证集。这样分割的方式可以有效的防止模型在训练过程中产生过拟合的问题。在训练过程中，由于数据集较小，这里做
<span class="math inline">\(10\)</span> 折交叉验证。使用
<code>sklearn.model_selection.ShuffleSplit()</code>
类创建以上分割方法。</p>
<pre class="language-python" data-language="python"><code class="language-python">cv_split <span class="token operator">=</span> ShuffleSplit<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">.3</span><span class="token punctuation">,</span> train_size<span class="token operator">=</span><span class="token number">.6</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span></code></pre>
<p>首先根据原数据集在没有经过放缩（scale）时进行训练，训练过程中输出准确率、召回率及
F1 Score 作为模型的评价标准。</p>
<pre class="language-python" data-language="python"><code class="language-python">columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Model'</span><span class="token punctuation">,</span> <span class="token string">'Fit Time'</span><span class="token punctuation">,</span> <span class="token string">'Accuracy'</span><span class="token punctuation">,</span> <span class="token string">'Recall'</span><span class="token punctuation">,</span> <span class="token string">'F1'</span><span class="token punctuation">]</span>
wo_scale <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns<span class="token punctuation">)</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> model <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">:</span>
    score <span class="token operator">=</span> cross_validate<span class="token punctuation">(</span>model<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
                           cv<span class="token operator">=</span>cv_split<span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 
                           scoring<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">,</span> <span class="token string">'recall'</span><span class="token punctuation">,</span> <span class="token string">'f1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    wo_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'Model'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pipe_dict<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    wo_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'Fit Time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">[</span><span class="token string">'fit_time'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wo_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'Accuracy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">[</span><span class="token string">'test_accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wo_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'Recall'</span><span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">[</span><span class="token string">'test_recall'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wo_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'F1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">[</span><span class="token string">'test_f1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
wo_scale<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

wo_scale</code></pre>
<p>得到的训练结果如下表所示：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2014.34.58.png"
alt="截屏2022-10-17 14.34.58" />
<figcaption aria-hidden="true">截屏2022-10-17 14.34.58</figcaption>
</figure>
<p>将以上评价指标分别绘制成柱状图：</p>
<pre class="language-python" data-language="python"><code class="language-python">fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

fig<span class="token punctuation">.</span>suptitle<span class="token punctuation">(</span><span class="token string">'Model Metrics'</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>wo_scale<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Accuracy'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Model'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Model Accuracy w. Scaling (%)'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Model'</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>wo_scale<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Recall'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Model'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Model Recall w. Scaling (%)'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Model'</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>wo_scale<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'F1'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Model'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Model F1 Score w. Scaling (%)'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Model'</span><span class="token punctuation">)</span></code></pre>
<p>得到输出：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___50_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>分类预测最重要的指标应当是准确率。从准确率图中看，几个树模型都得到了较好的预测结果。</p>
<p>之后，对数据进行放缩，这里使用的是对数据进行标准化处理，即 <span
class="math display">\[
z=\frac{X-\mu}{\sigma},\quad \text{where }E(X)=\mu,\ D(X)=\sigma^2
\]</span> 这里使用 <code>sklearn.preprocessing.StandardScaler()</code>
类进行。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler

scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
X_train <span class="token operator">=</span> scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
X_test <span class="token operator">=</span> scaler<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span></code></pre>
<p>重新使用表中的十个模型进行训练，评价指标和之前相同。</p>
<pre class="language-python" data-language="python"><code class="language-python">columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Model'</span><span class="token punctuation">,</span> <span class="token string">'Fit Time'</span><span class="token punctuation">,</span> <span class="token string">'Accuracy'</span><span class="token punctuation">,</span> <span class="token string">'Recall'</span><span class="token punctuation">,</span> <span class="token string">'F1'</span><span class="token punctuation">]</span>
w_scale <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns<span class="token punctuation">)</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> model <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">:</span>
    score <span class="token operator">=</span> cross_validate<span class="token punctuation">(</span>model<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
                           cv<span class="token operator">=</span>cv_split<span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 
                           scoring<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">,</span> <span class="token string">'recall'</span><span class="token punctuation">,</span> <span class="token string">'f1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    w_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'Model'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pipe_dict<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    w_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'Fit Time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">[</span><span class="token string">'fit_time'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    w_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'Accuracy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">[</span><span class="token string">'test_accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    w_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'Recall'</span><span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">[</span><span class="token string">'test_recall'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
    w_scale<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token string">'F1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> score<span class="token punctuation">[</span><span class="token string">'test_f1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>
w_scale<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

w_scale</code></pre>
<p>得到下标的训练结果：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2014.40.50.png"
alt="截屏2022-10-17 14.40.50" />
<figcaption aria-hidden="true">截屏2022-10-17 14.40.50</figcaption>
</figure>
<p>可以看到，对于几个受特征数值影响较大的模型，其准确率都有了较大的提升。</p>
<p>将做过 scaling 的数据的训练结果绘制成柱状图：</p>
<pre class="language-python" data-language="python"><code class="language-python">fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

fig<span class="token punctuation">.</span>suptitle<span class="token punctuation">(</span><span class="token string">'Model Metrics'</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>w_scale<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Accuracy'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Model'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Model Accuracy w. Scaling (%)'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Model'</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>w_scale<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Recall'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Model'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Model Recall w. Scaling (%)'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Model'</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>barplot<span class="token punctuation">(</span>data<span class="token operator">=</span>w_scale<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'F1'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Model'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Model F1 Score w. Scaling (%)'</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Model'</span><span class="token punctuation">)</span></code></pre>
<p>得到输出：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___53_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<h2 id="模型调优">5 模型调优</h2>
<p>可以看到，在第 4 部分中两次训练准确率较高的都是树模型，其中 GBDT
的几个实现算法表现都相当突出。事实上，我对这几个模型都进行了实验，最后在测试集提交结果时，得分最高的是
XGBoost 。这里就以 XGBoost
的模型调优为例，对模型调优过程进行讲述，对于其他模型而言，整体过程大同小异。</p>
<p>对于机器学习的模型调优，最基本的方法就是网格搜索。所谓网格搜索，就是在给定的几个参数选择中依据给定的评价标准，找寻效果最好一组参数组合。通常情况下，这一过程根据硬件环境的不同，会消耗相当长的时间。</p>
<p>我们首先定义网格搜索函数：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">grid_search</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">:</span>
    searcher <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>model<span class="token punctuation">,</span> params<span class="token punctuation">,</span> 
                            cv<span class="token operator">=</span>cv_split<span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 
                            scoring<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">,</span> <span class="token string">'recall'</span><span class="token punctuation">,</span> <span class="token string">'f1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> refit<span class="token operator">=</span><span class="token string">'accuracy'</span><span class="token punctuation">,</span>
                            verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    searcher<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
    best_model <span class="token operator">=</span> searcher<span class="token punctuation">.</span>best_estimator_
    score <span class="token operator">=</span> cross_validate<span class="token punctuation">(</span>best_model<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> 
                           cv<span class="token operator">=</span>cv_split<span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 
                           scoring<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'accuracy'</span><span class="token punctuation">,</span> <span class="token string">'recall'</span><span class="token punctuation">,</span> <span class="token string">'f1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Best score'</span><span class="token punctuation">,</span> searcher<span class="token punctuation">.</span>best_score_<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Best params'</span><span class="token punctuation">,</span> searcher<span class="token punctuation">.</span>best_params_<span class="token punctuation">)</span>
    <span class="token keyword">return</span> best_model</code></pre>
<p>这里使用了 <code>sklearn.model_selection.GridSearchCV()</code> 和
<code>sklearn.model_selection.cross_validate()</code> 方法来进行带 <span
class="math inline">\(K\)</span>
折交叉验证的参数网格搜索。<code>cv_split</code> 使用的是上文第 4
部分中定义的数据集分割方式，每次搜索训练仍然都输出准确率、召回率和 F1
Score，参数的最优指标设置为参照准确率进行比较。函数最终返回搜索到的最佳模型和该模型的最佳参数组合。</p>
<p>创建 XGBoost 分类器类实例和参数字典，开始网格化搜索，这里开启了 GPU
以加速搜索过程。对于参数字典 <code>params_xgb</code>
当中的几个参数的含义，可以参照 XGBoost
论文原文和官方文档，这里不进行解释。</p>
<pre class="language-python" data-language="python"><code class="language-python">clf_xgb <span class="token operator">=</span> XGBClassifier<span class="token punctuation">(</span>objective<span class="token operator">=</span><span class="token string">'binary:logistic'</span><span class="token punctuation">,</span> tree_method<span class="token operator">=</span><span class="token string">'gpu_hist'</span><span class="token punctuation">)</span>
params_xgb <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'n_estimators'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">'reg_lambda'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">'gamma'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">'learning_rate'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">0.03</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">&#125;</span>
best_model <span class="token operator">=</span> grid_search<span class="token punctuation">(</span>clf_xgb<span class="token punctuation">,</span> params_xgb<span class="token punctuation">)</span></code></pre>
<p>在搜索 <span class="math inline">\(720\)</span> 次即训练了 <span
class="math inline">\(720\)</span>
次之后，得到了最优参数和最优成绩。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2014.53.10.png"
alt="截屏2022-10-17 14.53.10" />
<figcaption aria-hidden="true">截屏2022-10-17 14.53.10</figcaption>
</figure>
<h2 id="模型结果可视化">6 模型结果可视化</h2>
<p>在这一部分中，我们会通过不同方式，展示模型的训练结果。</p>
<h3 id="分类结果报告">6.1 分类结果报告</h3>
<p>在 sklearn
的指标库中，设计了这样一个类，用于展示分类结果：<code>sklearn.metrics.classification_report()</code>
。我们这里使用训练好的最佳模型，在原训练集上（题目所给的完整训练集）做分类预测，并查看一下预测结果。</p>
<pre class="language-python" data-language="python"><code class="language-python">best_preds <span class="token operator">=</span> best_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
classification_report<span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> best_preds<span class="token punctuation">,</span> output_dict<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<p>正常情况下如果不设置 <code>output_dict=True</code>
，应该输出一个类似表格的纵横结构，但这里如果不设置的话输出会有问题。得到的分类结果报告输出为：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2014.58.53.png"
alt="截屏2022-10-17 14.58.53" />
<figcaption aria-hidden="true">截屏2022-10-17 14.58.53</figcaption>
</figure>
<p>从数值上看，我们搜索到的最佳模型在训练集上的预测效果还是相当出色的。</p>
<h3 id="混淆矩阵">6.2 混淆矩阵</h3>
<p>第二，既然我们要分析准确率、召回率和 F1
Score，就少不了分析混淆矩阵（Confusion Matrix）。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/image-20221017150207169.png"
alt="image-20221017150207169" />
<figcaption aria-hidden="true">image-20221017150207169</figcaption>
</figure>
<p>这些指标的计算公式都是老生常谈了，这里就不给出了。sklearn
提供了现成的类 <code>sklearn.metrics.confusion_matrix()</code>
用于计算混淆矩阵。我们还是计算在原训练集上的混淆矩阵，之后对该矩阵做正则化以更好的显示比例关系。</p>
<pre class="language-python" data-language="python"><code class="language-python">cnf_mat_wo_nml <span class="token operator">=</span> confusion_matrix<span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> best_preds<span class="token punctuation">)</span>
cnf_mat_w_nml <span class="token operator">=</span> confusion_matrix<span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> best_preds<span class="token punctuation">,</span> normalize<span class="token operator">=</span><span class="token string">'true'</span><span class="token punctuation">)</span></code></pre>
<p>通过参数 <code>normalize</code>
，可以设定混淆矩阵是否进行正则化。</p>
<p>之后，我们通过 <code>sns.heatmap()</code>
将混淆矩阵进行可视化。首先是未正则化的混淆矩阵可视化实现。</p>
<pre class="language-python" data-language="python"><code class="language-python">tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Dead'</span><span class="token punctuation">,</span> <span class="token string">'Survived'</span><span class="token punctuation">]</span>
np<span class="token punctuation">.</span>set_printoptions<span class="token punctuation">(</span>precision<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>cnf_mat_wo_nml<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'Blues'</span><span class="token punctuation">,</span> fmt<span class="token operator">=</span><span class="token string">'d'</span><span class="token punctuation">,</span>
            linewidth<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> linecolor<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">,</span>
            yticklabels<span class="token operator">=</span>tokens<span class="token punctuation">,</span>
            xticklabels<span class="token operator">=</span>tokens<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix w.o. Normalization"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'True label'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Predicted label'</span><span class="token punctuation">)</span></code></pre>
<p>之后是正则化过后的混淆矩阵的实现。</p>
<pre class="language-python" data-language="python"><code class="language-python">sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>cnf_mat_w_nml<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'Blues'</span><span class="token punctuation">,</span>
            linewidth<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> linecolor<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">,</span>
            yticklabels<span class="token operator">=</span>tokens<span class="token punctuation">,</span>
            xticklabels<span class="token operator">=</span>tokens<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Confusion Matrix w. Normalization"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'True label'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Predicted label'</span><span class="token punctuation">)</span></code></pre>
<p><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___59_1-20221017150747118.png"
alt="img" /><img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___60_1.png"
alt="img" /></p>
<p>从进行正则化后的混淆矩阵中正对角线的数值可以明显看到，我们训练的模型的正例率还是很高的，都达到了
0.9 以上。</p>
<h3 id="特征重要性">6.3 特征重要性</h3>
<p>第三，我们希望得知诸特征的重要性。树模型都有这样的特点，随机森林模型采用计算袋外数据错误率以及基尼系数的方式量化特征重要性，而
XGBoost
通过计算在子树模型分裂时用到的特征次数、节点分裂时特征带来信息增益优化的平均值及树模型在分裂时特征下的叶子结点涵
盖的样本数除以特征用来分裂的次数，即 weight、gain、cover
三种方式来计算特征重要性。</p>
<p>xgboost 库提供了这样的 API ，用于可视化模型中特征的重要性。但由于
xgboost
库的特点，训练后的特征名和原有数据的特征名是无法对应的，所以在可视化之前需要将原有数据特征名转存为一个
<code>.fmap</code> 文件供 xgboost 库的 API 读取。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> xgboost

<span class="token keyword">def</span> <span class="token function">create_feature_map</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">:</span>
    outfile <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'xgb.fmap'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> feat <span class="token keyword">in</span> features<span class="token punctuation">:</span>
        outfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'&#123;0&#125;\t&#123;1&#125;\tq\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> feat<span class="token punctuation">)</span><span class="token punctuation">)</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
    outfile<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
create_feature_map<span class="token punctuation">(</span>all_features<span class="token punctuation">.</span>columns<span class="token punctuation">)</span></code></pre>
<p>转存成功后，进行特征重要性的可视化。</p>
<pre class="language-python" data-language="python"><code class="language-python">plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">"figure.figsize"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
xgboost<span class="token punctuation">.</span>plot_importance<span class="token punctuation">(</span>best_model<span class="token punctuation">,</span> fmap<span class="token operator">=</span><span class="token string">'xgb.fmap'</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___61_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>可以看到，XGBoost 模型中，最重要的特征是船费 <code>Fare</code>
，其次是年龄 <code>Age</code> 。我们新创建的特征 <code>Family</code>
在特征重要性上而又很大的占比。</p>
<h3 id="xgboost-树模型可视化">6.4 XGBoost 树模型可视化</h3>
<p>最后，我们对训练的 XGBoost 模型进行可视化。树模型可视化一般都使用
graphviz 库进行，xgboost 库内部提供了这样的 API
<code>xgboost.to_graphviz()</code> 用于将训练好的模型可视化。</p>
<pre class="language-python" data-language="python"><code class="language-python">graph <span class="token operator">=</span> xgboost<span class="token punctuation">.</span>to_graphviz<span class="token punctuation">(</span>best_model<span class="token punctuation">,</span> fmap<span class="token operator">=</span><span class="token string">'xgb.fmap'</span><span class="token punctuation">)</span>
graph<span class="token punctuation">.</span><span class="token builtin">format</span> <span class="token operator">=</span> <span class="token string">'png'</span>
graph<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token string">'view'</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/view.png" alt="view"  /></p>
<h2 id="提交结果">7 提交结果</h2>
<p>使用我们训练好的模型在测试机上进行预测，并生成预测标签：</p>
<pre class="language-python" data-language="python"><code class="language-python">preds <span class="token operator">=</span> best_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span></code></pre>
<p>将预测标签和测试集的乘客 ID 拼接，形成提交结果，并保存在
<code>submission.csv</code> 中。</p>
<pre class="language-python" data-language="python"><code class="language-python">submission <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">:</span> test_data<span class="token punctuation">.</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> label<span class="token punctuation">:</span> preds<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
submission<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'submission.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre>
<p>至此，对本次实验过程的讲述就完全结束了。本次实验中，在 Kaggle
上提交的最高得分是 0.77751。</p>
<h2 id="automl-方法">8 AutoML 方法</h2>
<p>在最后，我觉得有必要提及这种看似有点 “投机取巧”
的方法。事实上，在正式做本次实验之前，我使用了 AutoML
方法，并达到了不错的准确率。</p>
<p>很明显的，本次实验是一个表格型数据，所以当时考虑了用自动机器学习的方法首先进行尝试，观察其效果如何。我使用的
AutoML 框架是来自 Amazon 的 AutoGluon。这一框架对应的论文链接是 <a
target="_blank" rel="noopener" href="https://arxiv.org/pdf/2003.06505.pdf">AutoGluon-Tabular: Robust
and Accurate AutoML for Structured Data (arxiv.org)</a> 。</p>
<p>有关 AutoGluon 的介绍可以参考李沐的视频 <a
target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1rh411m7Hb/?spm_id_from=333.999.0.0&amp;vd_source=1b593cdfd9bb21d02f97782b5ff0ac4a">10行代码战胜90%数据科学家？_哔哩哔哩_bilibili</a>
和 autogluon 的官方文档 <a
target="_blank" rel="noopener" href="https://auto.gluon.ai/stable/index.html">AutoGluon: AutoML for
Text, Image, and Tabular Data — AutoGluon Documentation 0.5.2
documentation</a> 。</p>
<p>这里就简要的将我使用 autoML
方法的过程进行讲述，完整的代码你可以在前面给出的 Kaggle notebook
链接中找到。首先安装环境，这里安装的是基于 MXNet 后端的
AutoGluon，但实际上在安装过程中也下载了 PyTorch。</p>
<pre class="language-python" data-language="python"><code class="language-python">!pip install <span class="token string">"mxnet&lt;2.0.0"</span>
!pip install autogluon</code></pre>
<p>在安装完毕后，就可以进行模型的训练了。首先仍然是读入数据，并标注 ID
列和标签列。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'/kaggle/input/titanic/train.csv'</span><span class="token punctuation">)</span>
test_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'/kaggle/input/titanic/test.csv'</span><span class="token punctuation">)</span>
<span class="token builtin">id</span><span class="token punctuation">,</span> label <span class="token operator">=</span> <span class="token string">'PassengerId'</span><span class="token punctuation">,</span> <span class="token string">'Survived'</span></code></pre>
<p>AutoGluon
框架会自动做特征工程，但我们对其做一点简单的特征工程可以让模型的效果变得更好。这里就简单的做了一点特征工程。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int64'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int64'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
all_features <span class="token operator">=</span> train_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
all_features <span class="token operator">=</span> all_features<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Name'</span><span class="token punctuation">,</span> <span class="token string">'Embarked'</span><span class="token punctuation">,</span> <span class="token string">'Ticket'</span><span class="token punctuation">,</span> <span class="token string">'Cabin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>median<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> LabelEncoder

encoder <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
all_features<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span> <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>all_features<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>对于 Tabular Data，AutoGluon 提供了很简单的 API 进行训练：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> autogluon<span class="token punctuation">.</span>tabular <span class="token keyword">import</span> TabularDataset<span class="token punctuation">,</span> TabularPredictor

predictor <span class="token operator">=</span> TabularPredictor<span class="token punctuation">(</span>label<span class="token operator">=</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>all_features<span class="token punctuation">)</span></code></pre>
<p>以上的代码默认是进行最快速的最优模型的搜索。也可以通过一些参数的设定达到最优效果的搜索，甚至可以设置一些集成学习的参数，例如下面的代码：</p>
<pre class="language-python" data-language="python"><code class="language-python">predictor <span class="token operator">=</span> TabularPredictor<span class="token punctuation">(</span>label<span class="token operator">=</span>label<span class="token punctuation">,</span> eval_metric<span class="token operator">=</span><span class="token string">"accuracy"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
    train_data<span class="token punctuation">,</span> presets<span class="token operator">=</span><span class="token string">'best_quality'</span><span class="token punctuation">,</span> num_bag_folds<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> num_stack_levels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre>
<p>这段代码的结果很长，这里就不展示了，你可以在我的 Kaggle notebook
上找到。大致的过程就是，AutoGluon
首先识别每一列特征的类型，并进行自动特征工程。之后，使用 NAS （Network
Architecture
Searching）算法对一系列模型进行搜索，并进行自动调参，以找到表现最好的模型。</p>
<p>训练完成后，可以通过 <code>predictor.fit_summary()</code>
查看每个匹配过的模型的表现情况。这里的输出结果也很长，就不进行展示了，在我的
Kaggle notebook 上也可以找到。</p>
<p>对测试集进行和训练集同样的处理，之后使用训练的模型进行预测。</p>
<pre class="language-python" data-language="python"><code class="language-python">test_data <span class="token operator">=</span> test_data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Name'</span><span class="token punctuation">,</span> <span class="token string">'Embarked'</span><span class="token punctuation">,</span> <span class="token string">'Ticket'</span><span class="token punctuation">,</span> <span class="token string">'Cabin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">'Age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>median<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span> <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">'Sex'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token string">'Fare'</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">'Fare'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">'Fare'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>预测的代码也很简单，只是调用 <code>predictor</code> 的
<code>predict()</code> 方法。</p>
<pre class="language-python" data-language="python"><code class="language-python">preds <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span></code></pre>
<p>最后，生成结果文件。</p>
<pre class="language-python" data-language="python"><code class="language-python">submission <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">:</span> test_data<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token punctuation">:</span> preds<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
submission<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'submission.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre>
<p>我使用 AutoGluon 通过 AutoML 的方式进行分类预测，提交的最高成绩是
0.7799。如果对数据集不进行任何处理，直接进行 AutoML，提交的成绩大概在
0.76 左右。</p>
<p>当然，除了 AutoGluon 以外，还有许多 AutoML 框架，如较为有名的 H2O 和
MLBox。关于在这一问题上使用 AutoML 方法的更多信息可以参考 <a
target="_blank" rel="noopener" href="https://www.kaggle.com/code/leomauro/automl-benchmark-titanic-disaster">AutoML
Benchmark - Titanic Disaster | Kaggle</a> 。</p>
<h2 id="总结">9 总结</h2>
<p>本文通过常规机器学习和 AutoML 两种方法，实现了 Titanic
数据集上的二分类问题。两种方法在经过调优后，在验证集上都达到了接近 <span
class="math inline">\(90\%\)</span>
的准确率，在最后测试集的结果提交上也都取得了 0.77 左右的分数。</p>
<p>对于机器学习方法（这里指非深度学习方法），树模型在各种数据集上的综合表现都很好，尤其是几种
GBDT 的实现，本文也是最终使用了在这一数据上表现相对优秀的
XGBoost作为最终的模型。当然，如果还想要继续提升准确率，还可以使用很多
trick，例如做 stacking 或者
ensemble，通过多种模型的堆叠或投票，可以使得最终的结果更加准确，但这样带来的后果是模型变得十分臃肿，训练时间也被拉长。如果没有很好的硬件环境，这样的方法应该是不适合的。本文只是使用单一模型进行二分类问题的训练，没有使用更高深的
trick。</p>
<p>对于这一问题，应该也可以使用 MLP
即多层感知机的方式训练神经网络，通过神经网络完成二分类问题。但本次实验中老师主要想体现和让我们实践的是非神经网络的机器学习方法，所以本文也没有使用神经网络完成二分类任务。</p>
<p>通过本次实验，使我对于数据清洗的过程有了更深的体会，对于特征工程的理解也更加深刻。通过对几种机器学习方法的使用，对于
sklearn
等一众机器学习库的了解更加全面。在整个实验过程之后，我对于数据分析的过程更加清晰。</p>
<h2 id="references">10 References</h2>
<p>本文参考了一些文档、博客和 Kaggle 平台上的几个
Notebook，这里将这些参考文献进行梳理。</p>
<p>本文参考的文档主要是 sklearn、xgboost、seaborn、matplotlib 和
AutoGluon 的官方文档：</p>
<ul>
<li>sklearn 官方文档：<a
target="_blank" rel="noopener" href="https://scikit-learn.org/stable/index.html">scikit-learn: machine
learning in Python — scikit-learn 1.1.2 documentation</a></li>
<li>xgboost 官方文档：<a
target="_blank" rel="noopener" href="https://xgboost.readthedocs.io/en/stable/index.html">XGBoost
Documentation — xgboost 1.6.2 documentation</a></li>
<li>seaborn 官方文档：<a target="_blank" rel="noopener" href="https://seaborn.pydata.org/api.html">API
reference — seaborn 0.12.0 documentation (pydata.org)</a></li>
<li>matplotlib 官方文档：<a
target="_blank" rel="noopener" href="https://matplotlib.org/stable/index.html">Matplotlib documentation
— Matplotlib 3.6.0 documentation</a></li>
<li>AutoGluon 官方文档：<a
target="_blank" rel="noopener" href="https://auto.gluon.ai/stable/index.html">AutoGluon: AutoML for
Text, Image, and Tabular Data — AutoGluon Documentation 0.5.2
documentation</a></li>
</ul>
<p>本文主要参考的 Kaggle Notebook 有以下几个：</p>
<ul>
<li><a
target="_blank" rel="noopener" href="https://www.kaggle.com/code/ldfreeman3/a-data-science-framework-to-achieve-99-accuracy">A
Data Science Framework: To Achieve 99% Accuracy | Kaggle</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.kaggle.com/code/ahmeturunveren/titanic-eda">Titanic
EDA | Kaggle</a></li>
<li><a
target="_blank" rel="noopener" href="https://www.kaggle.com/code/leomauro/automl-benchmark-titanic-disaster">AutoML
Benchmark - Titanic Disaster | Kaggle</a></li>
</ul>
<p>本文参考的博客有很多，主要为调试一些 bug
和查找一些想法的实现方法，这里由于篇幅原因就不一一列出了。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>LeoLang
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://www.leolang.top/2022/10/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2006/" title="数据分析实验 06">https://www.leolang.top/2022/10/17/数据分析实验 06/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a>
              <a href="/tags/Data-Analysis/" rel="tag"><i class="fa fa-tag"></i> Data Analysis</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/10/10/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2005/" rel="prev" title="数据分析实验 05">
                  <i class="fa fa-chevron-left"></i> 数据分析实验 05
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/10/31/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2007/" rel="next" title="数据分析实验 07">
                  数据分析实验 07 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="SOHUCS"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LeoLang</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">433k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">6:34</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>



  <script class="next-config" data-name="nprogress" type="application/json">{"enable":true,"spinner":true}</script>
  <script src="/js/third-party/nprogress.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"41UWIC7MMp6zIfeLwJ9NYyGs-gzGzoHsz","app_key":"ITEb4maRYOsE2d4OazXV9neM","server_url":"https://41uwic7m.lc-cn-n1-shared.com","security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyvB8TI3f","appkey":"73c618e7e6297e7a69f0c1377f03ffc4"}</script>
<script src="/js/third-party/comments/changyan.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModePath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"positon":"right","width":150,"height":300},"mobile":false,"log":false,"pluginModelPath":"assets/"});</script></body>
</html>
