<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha256-no0c5ccDODBwp+9hSmV5VvPpKwHCpbVzXHexIkupM6U=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" integrity="sha256-a5YRB27CcBwBFcT5EF/f3E4vzIqyHrSR878nseNYw64=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.leolang.top","root":"/","images":"/images","scheme":"Gemini","version":"8.7.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":true,"lazyload":false,"nav":null,"activeClass":"changyan"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="数据分析实验 07 前言 本文介绍了数据分析第七次实验的实验过程。第七次实验主要针对的是时间序列分析问题进行展开，对于电力负荷的一些问题进行了解决。 本文大量使用了神经网络进行时间序列的分析，尤其是使用了单输出的 LSTM 神经网络和多输出的 LSTM 神经网络，在一些问题上取得了不错的效果，但仍在另一些问题上没有得到比较令人满意的效果。">
<meta property="og:type" content="article">
<meta property="og:title" content="数据分析实验 07">
<meta property="og:url" content="https://www.leolang.top/2022/10/31/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2007/index.html">
<meta property="og:site_name" content="W1ndness的技术栈">
<meta property="og:description" content="数据分析实验 07 前言 本文介绍了数据分析第七次实验的实验过程。第七次实验主要针对的是时间序列分析问题进行展开，对于电力负荷的一些问题进行了解决。 本文大量使用了神经网络进行时间序列的分析，尤其是使用了单输出的 LSTM 神经网络和多输出的 LSTM 神经网络，在一些问题上取得了不错的效果，但仍在另一些问题上没有得到比较令人满意的效果。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-31%2000.49.08.png">
<meta property="article:published_time" content="2022-10-30T16:00:00.000Z">
<meta property="article:modified_time" content="2022-10-30T17:09:33.267Z">
<meta property="article:author" content="LeoLang">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Data Analysis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-31%2000.49.08.png">


<link rel="canonical" href="https://www.leolang.top/2022/10/31/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2007/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.leolang.top/2022/10/31/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2007/","path":"2022/10/31/数据分析实验 07/","title":"数据分析实验 07"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>数据分析实验 07 | W1ndness的技术栈</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="W1ndness的技术栈" type="application/rss+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">W1ndness的技术栈</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Based on Hexo-NexT</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">72</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">24</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">54</span></a></li>
        <li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C-07"><span class="nav-text">数据分析实验 07</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="nav-text">0 写在前面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E9%87%8D%E8%BF%B0"><span class="nav-text">1 问题重述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="nav-text">2 问题分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80"><span class="nav-text">2.1 问题一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C"><span class="nav-text">2.2 问题二</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="nav-text">3 背景知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E5%88%86%E6%9E%90%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">3.1 时间序列分析基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E7%9A%84%E5%B7%AE%E5%88%86"><span class="nav-text">3.1.1 时间序列的差分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%A7"><span class="nav-text">3.1.2 时间序列的相关性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E7%9A%84%E5%B9%B3%E7%A8%B3%E6%80%A7"><span class="nav-text">3.1.3 时间序列的平稳性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95"><span class="nav-text">3.2 常用时间序列分析方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#armaarma-%E5%92%8C-arima"><span class="nav-text">3.2.1 AR、MA、ARMA 和 ARIMA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%A0%E7%BB%9F%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="nav-text">3.2.2 传统机器学习方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95"><span class="nav-text">3.2.3 深度学习方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%B8%801%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">4 问题一（1）的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87%E4%B8%80%E9%98%B6%E6%AE%B5"><span class="nav-text">4.1 数据准备一阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8-arima-%E8%BF%9B%E8%A1%8C-eda"><span class="nav-text">4.2 尝试使用 ARIMA 进行 EDA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87%E4%BA%8C%E9%98%B6%E6%AE%B5"><span class="nav-text">4.3 数据准备二阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA-lstm-%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C"><span class="nav-text">4.4 搭建 LSTM 神经网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83"><span class="nav-text">4.5 开始训练</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-text">4.6 进行测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E9%A2%84%E6%B5%8B"><span class="nav-text">4.7 完成预测</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%B8%802%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">5 问题一（2）的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-text">5.1 数据准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%8F%E6%97%A5%E6%9C%80%E5%A4%A7%E5%80%BC%E7%9A%84%E8%A7%A3%E5%86%B3"><span class="nav-text">5.2 对每日最大值的解决</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E8%BE%93%E5%87%BA-lstm"><span class="nav-text">5.2.1 多输出 LSTM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E8%BE%93%E5%87%BA-lstm"><span class="nav-text">5.2.2 单输出 LSTM</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%8F%E6%97%A5%E6%9C%80%E5%B0%8F%E5%80%BC%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">5.3 对每日最小值的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">6 问题二的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87-1"><span class="nav-text">6.1 数据准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AA%81%E5%8F%98%E7%82%B9%E5%88%86%E6%9E%90"><span class="nav-text">6.2 突变点分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="nav-text">7 实验总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="LeoLang"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">LeoLang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/w1ndness" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;w1ndness" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/imbaleo@163.com" title="E-Mail → imbaleo@163.com"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



          </div>
        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/W1ndness" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.leolang.top/2022/10/31/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2007/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="LeoLang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="W1ndness的技术栈">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          数据分析实验 07
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-31 00:00:00 / 修改时间：01:09:33" itemprop="dateCreated datePublished" datetime="2022-10-31T00:00:00+08:00">2022-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%9D%82%E6%96%87/" itemprop="url" rel="index"><span itemprop="name">学习杂文</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E6%9D%82%E6%96%87/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C/" itemprop="url" rel="index"><span itemprop="name">数据分析实验</span></a>
        </span>
    </span>

  
    <span id="/2022/10/31/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2007/" class="post-meta-item leancloud_visitors" data-flag-title="数据分析实验 07" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2022/10/31/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2007/#SOHUCS" itemprop="discussionUrl">
        <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2022/10/31/数据分析实验 07/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>41k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>37 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="数据分析实验-07">数据分析实验 07</h1>
<h1 id="前言">前言</h1>
<p>本文介绍了数据分析第七次实验的实验过程。第七次实验主要针对的是时间序列分析问题进行展开，对于电力负荷的一些问题进行了解决。
本文大量使用了神经网络进行时间序列的分析，尤其是使用了单输出的 LSTM
神经网络和多输出的 LSTM
神经网络，在一些问题上取得了不错的效果，但仍在另一些问题上没有得到比较令人满意的效果。</p>
<span id="more"></span>
<h2 id="写在前面">0 写在前面</h2>
<p>本次实验的主题内容是<strong>时间序列分析</strong>，即根据一系列包含时间且和时间有较强关联关系的数据进行数据分析。由于本次实验中涉及到了较大量的
GPU 使用（训练神经网络），我本机的算力已经不能支持。故这次实验利用了
Kaggle 平台的免费 GPU 算力进行。</p>
<p>本次实验的 Kaggle Notebook 链接是：<a
target="_blank" rel="noopener" href="https://www.kaggle.com/code/w1ndness/data-analysis-07-lstm">Data-Analysis-07-LSTM
| Kaggle</a> ，这里是实验的大部分代码，主要是基于 LSTM
进行的模型搭建。部分对于时间序列平稳性分析以及使用 ARIMA
进行的实验在另一个 Kaggle Notebook 中，连接在 <a
target="_blank" rel="noopener" href="https://www.kaggle.com/code/w1ndness/data-analysis-07-arima">Data-Analysis-07-ARIMA
| Kaggle</a> 。</p>
<h2 id="问题重述">1 问题重述</h2>
<p>1．地区负荷的中短期预测分析 （基础分）</p>
<p>根据附件中提供的某地区电网间隔 15
分钟的负荷数据，建立中短期负荷预测模型：</p>
<p>（1）给出该地区电网未来 10 天间隔 15
分钟的负荷预测结果，并分析其预测精度；</p>
<p>（2）给出该地区电网未来 3
个月日负荷的最大值和最小值预测结果，以及相应达到负荷最大值和最小值的时间，并分析其预测精度。</p>
<p>2．行业负荷的中期预测分析 （附加分）</p>
<p>对不同行业的用电负荷进行中期预测分析，能够为电网运营与调度决策提供重要依据。特别是在新冠疫情、国家“双碳”目标等背景下，通过对大工业、非普工业、普通工业和商业等行业的用电负荷进行预测，有助于掌握各行业的生产和经营状况、复工复产和后续发展走势，进而指导和辅助行业的发展决策。请根据附件中提供的各行业每天用电负荷相关数据，建立数学模型研究下面问题：</p>
<p>（1）挖掘分析各行业用电负荷突变的时间、量级和可能的原因。</p>
<p>（2）给出该地区各行业未来 3
个月日负荷最大值和最小值的预测结果，并对其预测精度做出分析。</p>
<h2 id="问题分析">2 问题分析</h2>
<p>附件共给出三张表，一是对于每 15
分钟的负荷数据，二是对于不同行业每天的负荷数据，三是对于每天的气象数据。</p>
<h3 id="问题一">2.1 问题一</h3>
<p>问题一中的两个小问都是对于时间序列的分析，本质上是一个时间序列预测问题。两问的差别在于时间序列的频度不同，对于模型的输入特征维度也不同。</p>
<p>对于第一小问而言，结合附件表 1，我们需要根据频度为 15
分钟的一维数据进行时间序列预测。对于这一问中，输入数据的维度只有 <span
class="math inline">\(1\)</span> ，因为我们除了表 1
中数据可以用来训练模型外没有其他额外特征。</p>
<p>对于第二小问而言，由于我们没有频度为一天的负荷数据，所以我们首先应当先根据附件表
1
中数据按一天为频度对数据进行处理，并取出每天负荷的最大值和最小值。另外，我们可以看到表
3
当中是按照一天为频度的气象数据。所以显然，我们可以将处理后的两表拼接后作为这一问模型的输入。但在观察表
3
数据后，发现该表数据相对比较杂乱，可能要经过比较复杂的数据清洗和特征工程后才能被使用。</p>
<h3 id="问题二">2.2 问题二</h3>
<p>在问题二中，与问题一不同的是增加了 “行业”
这一特征。对问题二中的两个问题，第二小问很明显的也是一个时间序列分析，方法应当与问题一中类似。</p>
<p>而对于第一小问，实际上是一个时间序列的突变点分析问题，对于这一问题有很多很成熟的方法，直接使用进行分析即可。</p>
<h2 id="背景知识">3 背景知识</h2>
<p>这里有必要也有需要对时间序列分析以及以下会涉及到的一些方法进行阐释，也能够使你更好的了解和理解之后的数据分析过程。</p>
<h3 id="时间序列分析基本概念">3.1 时间序列分析基本概念</h3>
<p>以下内容参考：<a
target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/127981316">数据分析模型9——预知未来的算法：时间序列分析
- 知乎 (zhihu.com)</a></p>
<p>时间序列是按照时间顺序，按照一定的时间间隔取得的一系列观测值，国内生产总值，消费者物价指数，利率，汇率，股票价格等等。时间间隔可以是日，周，月，季度，年等。</p>
<p>如何进行时间序列分析？通常来说我们尝试找出序列值在过去所呈现的特征模式，假定这种模式在未来能够持续，进而对未来进行预测。</p>
<p>时间序列基本特征包括：趋势性，序列相关性，随机性。趋势性是指序列整体上呈现单调性，如平稳、上涨或下跌。序列相关性是指当期的序列值和前期某个或某些序列值线性相关。随机性是指序列在一定程度上呈现不确定性，由于模型并不能捕捉到现实世界中的所有特征，总会有一些噪声的存在，这些噪声我们称之为白噪声。</p>
<p>在时间序列的特征模式找到后，就需要用特定的方法把这些特征抓取出来。</p>
<p>时间序列通常被表达为 <span
class="math inline">\(\{X_T|T=1,2,3,\cdots,n\}\)</span> ，其中 <span
class="math inline">\(X_T\)</span> 代表 <span
class="math inline">\(T\)</span> 时刻的时间序列值。</p>
<h3 id="时间序列的差分">3.1.1 时间序列的差分</h3>
<p>时间序列通常需要进行差分，以消除某些因素的影响，比如趋势性影响和季节性影响。通常涉及到的差分两种：</p>
<ul>
<li><p><span class="math inline">\(K\)</span> 阶差分</p>
<p>通常使用的是一阶差分和二阶差分：</p>
<ul>
<li>一阶差分：<span class="math inline">\(\nabla
X_T=X_T-X_{T-1}\)</span></li>
<li>二阶差分：<span class="math inline">\(\nabla X_T - \nabla
X_{T-1}=(X_T-X_{T-1})-(X_{T-1}-X_{T-2})\)</span></li>
</ul></li>
<li><p><span class="math inline">\(K\)</span> 步差分：<span
class="math inline">\(X_T-X_{T-K}\)</span></p></li>
</ul>
<p><span class="math inline">\(1\)</span>
阶差分可以剔除趋势型的影响，一般来说，二阶差分后的序列基本会变得水平。而
<span class="math inline">\(k\)</span> 步差分可以剔除季节性的影响。</p>
<h3 id="时间序列的相关性">3.1.2 时间序列的相关性</h3>
<p>通常使用自相关系数（ACF）和偏自相关系数（PACF）来衡量序列的相关性。ACF
用于度量同一事件在不同时期的相关程度，而 PACF
用于度量去除中间变量影响后的相关程度。通常可以通过绘制 ACF 图和 PACF
图来观察时间序列的相关性。</p>
<h3 id="时间序列的平稳性">3.1.3 时间序列的平稳性</h3>
<p>一个时间序列是平稳的，必须满足以下三个条件：</p>
<ul>
<li><span class="math inline">\(E(X_T)=\mu\)</span>
，即序列的期望值为常数。</li>
<li><span class="math inline">\(Var(X_T)=\sigma^2\)</span>
，即序列的方差为常数。</li>
<li><span class="math inline">\(r(h)=Cov(X_T,X_{T-h})\)</span>
，即对于所有 <span class="math inline">\(T\)</span> 以及 <span
class="math inline">\(h&gt;0\)</span> ，序列的协方差是由 <span
class="math inline">\(h\)</span> 唯一决定的函数，即 <span
class="math inline">\(h\)</span> 阶的相关性只与 <span
class="math inline">\(h\)</span> 有关，与时刻 <span
class="math inline">\(t\)</span> 无关。</li>
</ul>
<p>平稳性检验最直观的方式是绘制时间序列的时序图，但当数据量很大时，往往无法通过简单的一张图像就判断出时间序列的平稳性。常用的一种平稳性检验的方式是单位根检验，即
ADF（Augmented Dickey-Fuller）检验。</p>
<h2 id="常用时间序列分析方法">3.2 常用时间序列分析方法</h2>
<p>对于时间序列的分析，首先要求数据按照滑动窗口的方法被处理成输入数据和输出数据。接下来介绍的几种模型和方法都是基于这样的输入和输出的。</p>
<h3 id="armaarma-和-arima">3.2.1 AR、MA、ARMA 和 ARIMA</h3>
<p>在统计学角度，最常用的时间序列分析方法是自回归模型（AR）、移动平均模型（MA）、自回归移动平均模型（ARMA）和最一般的
ARIMA
模型。对于这些方法的选取和参数的确定，基本是基于差分处理和上文提到过的
ACF 和 PACF 图所进行的。</p>
<p>自回归模型是指当前时刻的时序值可由其过去值的线性组合加上一个白噪声，建里自回归模型
<span class="math inline">\(AR(p)\)</span>
的目的就是要搞清过去几期的历史值会影响当前值。自回归模型的特征是：没有趋势性，有相关性和随机性。</p>
<p>移动平均序列指的是当前时刻的时序值是过去 <span
class="math inline">\(q\)</span> 阶白噪声的线性组合，建立 <span
class="math inline">\(MA(q)\)</span>
模型的目的在于找出过去几期的白噪声影响了当前值。</p>
<h3 id="传统机器学习方法">3.2.2 传统机器学习方法</h3>
<p>传统的机器学习方法目前主流的方法是使用树模型及梯度提升树（GBDT）的一系列衍生模型，当然，也有使用非树模型的机器学习方法，如
K-近邻（KNN）等其他方法。</p>
<h3 id="深度学习方法">3.2.3 深度学习方法</h3>
<p>深度学习方法也是进行时间序列分析方法中较为常用的，目前主流的方法一共有以下几种：</p>
<ul>
<li><p>RNN / LSTM</p>
<p>使用循环神经网络进行对时间序列数据进行学习</p></li>
<li><p>CNN-LSTM</p>
<p>首先使用 1D-CNN 对数据进行建模，得到数据的
embedding，之后再将处理后数据输入 LSTM 进行学习</p></li>
<li><p>Transformer</p>
<p>基于 Transformer
架构的时间序列分析方法，主要内容是注意力机制（Attention）</p></li>
<li><p>encoder-decoder</p>
<p>基于编码器-解码器的方法，将输入数据输入到编码器里进行训练，得到一个训练好的
encoder，之后对于得到的编码进行解码，最终实现下游任务</p></li>
</ul>
<h2 id="问题一1的实现">4 问题一（1）的实现</h2>
<h3 id="数据准备一阶段">4.1 数据准备一阶段</h3>
<p>为保证训练过程中保存的模型不会互相干扰，首先通过 shell
命令删除之前存储的模型参数文件。</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">$ <span class="token operator">!</span>rm -f model*</code></pre>
<p>首先导入后续需要的一部分库。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> os
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns</code></pre>
<p>之后读入表 1 数据，即时间频度为 15 分钟的负荷数据。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'/kaggle/input/electrical-energy-load/train/1.csv'</span><span class="token punctuation">)</span>
train_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2019.29.36.png"
alt="截屏2022-10-30 19.29.36" />
<figcaption aria-hidden="true">截屏2022-10-30 19.29.36</figcaption>
</figure>
<p>修改列名以便于后续进行相关处理。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'Power'</span><span class="token punctuation">]</span>
train_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2019.29.54.png"
alt="截屏2022-10-30 19.29.54" />
<figcaption aria-hidden="true">截屏2022-10-30 19.29.54</figcaption>
</figure>
<p>查看训练数据的大小。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">.</span>shape</code></pre>
<p>输出是：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span><span class="token number">128156</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></code></pre>
<p>由于读入的数据是时序数据，我们无法保证其在时间性上没有缺失。按照实验
05 的时间填充框架，我们首先对数据涉及到的时间序列进行填充。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
grouper <span class="token operator">=</span> pd<span class="token punctuation">.</span>Grouper<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">'Date'</span><span class="token punctuation">,</span> freq<span class="token operator">=</span><span class="token string">'15min'</span><span class="token punctuation">)</span>
train_data <span class="token operator">=</span> train_data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>grouper<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2019.32.38.png"
alt="截屏2022-10-30 19.32.38" />
<figcaption aria-hidden="true">截屏2022-10-30 19.32.38</figcaption>
</figure>
<p>再次查看训练数据的大小。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">.</span>shape</code></pre>
<p>输出是：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span><span class="token number">128544</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<p>可以看到的是，的确训练数据的行数增加了，这也证明的确训练数据中有时间的缺失。之后，考虑应当如何填充空值。这里的数据是一个复杂的函数，个人认为简单的使用均值或其他统计量进行填充是不够合理的。这里使用的是插值方法对空值进行填充。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span><span class="token punctuation">)</span>
train_data<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>再次查看是否存在空值，可以发现已经没有空值了。</p>
<pre class="language-none"><code class="language-none">Power    0
dtype: int64</code></pre>
<p>将填充好的数据持久化存储为 <code>.csv</code>
文件，以便于后续处理时间频度为一天数据的相关问题时使用。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'15min_freq.csv'</span><span class="token punctuation">)</span></code></pre>
<p>我们希望观察负荷训练数据的大致分布规律，于是，我们取不同区间对于数据进行可视化。这里分别取区间
<span class="math inline">\([100,300]\)</span> 、<span
class="math inline">\([0, 1000]\)</span> 、<span
class="math inline">\([0, 10000]\)</span> 和全部数据进行可视化。</p>
<pre class="language-python" data-language="python"><code class="language-python">fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>lineplot<span class="token punctuation">(</span>data<span class="token operator">=</span>train_data<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">:</span><span class="token number">300</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Date'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Power'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>ax<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>lineplot<span class="token punctuation">(</span>data<span class="token operator">=</span>train_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Date'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Power'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>ax<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>lineplot<span class="token punctuation">(</span>data<span class="token operator">=</span>train_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Date'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Power'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>ax<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>lineplot<span class="token punctuation">(</span>data<span class="token operator">=</span>train_data<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'Date'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'Power'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>ax<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>可以看到，时间序列数据基本以一天为一个周期，即 96
个时间间隔为一个周期。从更长的时间区间观察数据，在数据的前半部分有一段不是很
“规整”
，在之后的过程中应当要考虑如何对这一部分进行处理。在和同学的交流过程中，发现的确删除前一段的反常数据会使得模型的效果更好。但我在这个过程中并没有删除。</p>
<h3 id="尝试使用-arima-进行-eda">4.2 尝试使用 ARIMA 进行 EDA</h3>
<p>首先，我尝试使用分析 ARIMA
模型的分析方法对所给的训练数据进行了一定的探索性数据分析（EDA）。</p>
<p>第一，我尝试画出数据的自相关系数和偏自相关系数图，即 ACF 图和 PACF
图。使用 <code>statsmodels.graphics</code> 模块对 ACF 和 PACF
进行可视化。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> statsmodels<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>tsaplots <span class="token keyword">import</span> plot_acf
<span class="token keyword">from</span> statsmodels<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>tsaplots <span class="token keyword">import</span> plot_pacf
<span class="token keyword">from</span> statsmodels<span class="token punctuation">.</span>tsa<span class="token punctuation">.</span>stattools <span class="token keyword">import</span> adfuller <span class="token keyword">as</span> ADF
<span class="token keyword">from</span> statsmodels<span class="token punctuation">.</span>stats<span class="token punctuation">.</span>diagnostic <span class="token keyword">import</span> acorr_ljungbox
<span class="token keyword">from</span> statsmodels<span class="token punctuation">.</span>tsa<span class="token punctuation">.</span>arima_model <span class="token keyword">import</span> ARIMA

fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plot_acf<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plot_pacf<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___11_0.png"
alt="results_11_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_11_0</figcaption>
</figure>
<p>第二，对数据进行 ADF 检验，观察数据是否平稳。</p>
<pre class="language-python" data-language="python"><code class="language-python">ADF<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'power'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>输出为：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">6.674613892094386</span><span class="token punctuation">,</span>
 <span class="token number">4.49789880639487e-09</span><span class="token punctuation">,</span>
 <span class="token number">72</span><span class="token punctuation">,</span>
 <span class="token number">128083</span><span class="token punctuation">,</span>
 <span class="token punctuation">&#123;</span><span class="token string">'1%'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">3.430401056198406</span><span class="token punctuation">,</span>
  <span class="token string">'5%'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">2.8615625660943227</span><span class="token punctuation">,</span>
  <span class="token string">'10%'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">2.566782011132868</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
 <span class="token number">2641933.054895261</span><span class="token punctuation">)</span></code></pre>
<p>观察输出数据可以很明确的发现，元组内第一个数据的范围 <span
class="math inline">\(&lt;-6.5\)</span>
，比三个置信度下的数据都小，所以可以根据 ADF
检验的结果判断数据是平稳的。</p>
<p>第三，绘制一阶滞后相关图，观察数据自相关性强度。这里使用的是
<code>pandas</code> 库自带的 <code>lag_plot()</code>
方法绘制滞后相关图。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pandas<span class="token punctuation">.</span>plotting <span class="token keyword">import</span> lag_plot

lag_plot<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'power'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___13_1.png"
alt="results_13_1" />
<figcaption
aria-hidden="true"><strong>results</strong>_13_1</figcaption>
</figure>
<p>可以看到，<span class="math inline">\(y(t+1)\)</span> 和 <span
class="math inline">\(y(t)\)</span>
的分布基本呈一条直线，其相关性还是相当高的。</p>
<p>第四，计算一阶滞后 Pearson 相关系数，观察相关性。这里使用的是
<code>scipy.stats</code> 所提供的 <code>pearsonr()</code> 方法。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>stats <span class="token keyword">import</span> pearsonr

pearsonr<span class="token punctuation">(</span>train_data<span class="token punctuation">[</span><span class="token string">'power'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> train_data<span class="token punctuation">[</span><span class="token string">'power'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>输出是：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span><span class="token number">0.9596894348446154</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span></code></pre>
<p>从这里也可以看到，数据的一阶滞后相关性是非常强的。</p>
<p>实际上，后面我也尝试了使用 ARIMA 模型进行预测，但单纯使用 ARIMA
的效果极其不好，原因是对于阶数的确定并不合理。对于这里给出的时间序列数据，使用
ARIMA 模型还需要在找到 <span class="math inline">\(p,q\)</span>
两阶数参数前首先进行季节性分解，之后再进行相关的分析，才能够得到较好的结果。由于这个过程较为复杂，我这次就放弃了这种方法，改用了
LSTM 进行训练。</p>
<h3 id="数据准备二阶段">4.3 数据准备二阶段</h3>
<p>使用神经网络进行预测，首先应当将数据切分成训练集、验证集和测试集，之后要将数据改造为恰当的张量形式，以供神经网络输入。需要说明的是，这里的验证集指的是对于训练集训练的模型进行模型表现评估的数据集，而测试集是测试模型在未知数据上表现情况的数据集，与平时我们所提到的这三种数据集稍有不同。</p>
<p>首先定义分割数据集函数，通过这一函数，将整个数据集分割为训练集、验证集和测试集。由于时间序列数据预测一般采用滑动窗口方式进行数据处理，所以这里也不能使用常规的切分函数，如
<code>sklearn.model_selection.train_test_split()</code> 等。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">split_dataset</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> train_size<span class="token operator">=</span><span class="token number">.8</span><span class="token punctuation">,</span> valid_size<span class="token operator">=</span><span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    X_train <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>data_size <span class="token operator">*</span> train_size<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    X_valid <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>data_size <span class="token operator">*</span> train_size<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>data_size <span class="token operator">*</span> train_size<span class="token punctuation">)</span> <span class="token operator">+</span> \
                   <span class="token builtin">int</span><span class="token punctuation">(</span>data_size <span class="token operator">*</span> valid_size<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    X_test <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>data_size <span class="token operator">*</span> train_size<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data_size <span class="token operator">*</span> valid_size<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> X_train<span class="token punctuation">,</span> X_valid<span class="token punctuation">,</span> X_test</code></pre>
<p>调用该函数进行切分：</p>
<pre class="language-python" data-language="python"><code class="language-python">train_bin<span class="token punctuation">,</span> valid_bin<span class="token punctuation">,</span> test_bin <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span></code></pre>
<p>之后，需要对数据进行归一化处理。这么做的目的是使得模型能够快速收敛，如果数据的量级很大，比如本题中数据基本在
<span class="math inline">\(10^6\)</span>
量级上，训练神经网络时这样的数据会导致模型收敛缓慢，也不利于我们训练模型。但是，由于我们是进行预测，进行归一化之后必须要在最终判断模型表现中计算各项指标时进行反归一化。</p>
<p>这里使用的方法是最大最小归一化，设数据的最大值为 <span
class="math inline">\(x_{max}\)</span> ，最小值为 <span
class="math inline">\(x_{min}\)</span> ，对于数据集中的某一数据 <span
class="math inline">\(x\)</span> ，其归一化后的结果 <span
class="math inline">\(x’\)</span> 应当为 <span class="math display">\[
x&#39;=\frac{x-x_{min}}{x_{max}-x_{min}}
\]</span> 由于这一问中数据只有一列，我们只需要使用
<code>sklearn.preprocessing.MinMaxScaler</code> 分别进行
<code>fit_transform()</code> 归一化和 <code>inverse_transform()</code>
进行反归一化即可。对于数据列数 <span class="math inline">\(\ge
2\)</span>
而需要反归一化的只有某几列时，反归一化的过程会相对复杂。这在解决问题二的过程中会有相应的阐述。</p>
<p>对本问中数据进行归一化：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> MinMaxScaler

train_scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
valid_scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
test_scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>

train_bin <span class="token operator">=</span> train_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>train_bin<span class="token punctuation">)</span>
valid_bin <span class="token operator">=</span> valid_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>valid_bin<span class="token punctuation">)</span>
test_bin <span class="token operator">=</span> test_scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>test_bin<span class="token punctuation">)</span></code></pre>
<p>现在，需要的数据我们已经准备好了，之后应当对数据进行滑动窗口切分。对于滑动窗口思想是如何实现的这里就不在阐述了，网上有大量的资料对其进行解释，在数据结构的学习过程中也应该对其有过了解。</p>
<p>这里定义一个预处理切分函数，将数据按滑动窗口切分成 <span
class="math inline">\(X\)</span> 和 <span
class="math inline">\(y\)</span>
的输入和输出，并在函数中就将输入输出直接转化成张量形式。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader<span class="token punctuation">,</span> TensorDataset

<span class="token keyword">def</span> <span class="token function">preprocessing</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> predict_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    X<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> window_size <span class="token operator">-</span> predict_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        X<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> window_size<span class="token punctuation">]</span><span class="token punctuation">)</span>
        y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> window_size<span class="token punctuation">:</span>i <span class="token operator">+</span> window_size <span class="token operator">+</span> predict_size<span class="token punctuation">]</span><span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    X <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> X<span class="token punctuation">,</span> y</code></pre>
<p>之后，分别对训练集、验证集和测试集进行滑动窗口切分处理，并生成张量数据集，即
<code>torch.utils.data.TensorDataset</code> 。</p>
<pre class="language-python" data-language="python"><code class="language-python">window_size<span class="token punctuation">,</span> predict_size <span class="token operator">=</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">1</span>

X_train<span class="token punctuation">,</span> y_train <span class="token operator">=</span> preprocessing<span class="token punctuation">(</span>train_bin<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> predict_size<span class="token punctuation">)</span>
X_valid<span class="token punctuation">,</span> y_valid <span class="token operator">=</span> preprocessing<span class="token punctuation">(</span>valid_bin<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> predict_size<span class="token punctuation">)</span>
X_test<span class="token punctuation">,</span> y_test <span class="token operator">=</span> preprocessing<span class="token punctuation">(</span>test_bin<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> predict_size<span class="token punctuation">)</span>

train_data <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
valid_data <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>X_valid<span class="token punctuation">,</span> y_valid<span class="token punctuation">)</span>
test_data <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>X_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span></code></pre>
<p>我们这里查看一下三个数据集中输入张量的形状，以防止前面的处理出现一些奇怪的问题，也保证后面神经网络的相应输入正确。</p>
<pre class="language-python" data-language="python"><code class="language-python">X_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> X_valid<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> X_test<span class="token punctuation">.</span>shape</code></pre>
<p>输出是：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">102738</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">12757</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">12758</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="搭建-lstm-神经网络">4.4 搭建 LSTM 神经网络</h3>
<p>截至目前，我们已经将第一问所要使用的数据已经都转化成了输入、输出的张量模式了。接下来，我们开始进行神经网络模型的一系列准备工作，包括设定训练设备（GPU等）、创建
<code>DataLoader</code> 和搭建网络。</p>
<p>第一，我们制定训练设备。这里我所实现的是一个能够实现多卡训练的模板，相关代码有一部分参考了网上的博客，但网上对于多卡训练的参考资料都很不正确。由于
Kaggle 目前提供了可以使用两块 T4 的 GPU 进行训练，我自己也租赁了一个两块
Tesla V100 的服务器，想要进行算力上的尝试，但最终由于代码的各种 bug
没有成功实现多卡训练过程，只是使用了单卡进行训练。但由于数据集不是过分的大，特征也相对较少，也不涉及到图片数据，单卡训练还是绰绰有余。但以下的所有代码都是基于可能进行多卡训练的过程所实现的，可以根据某些参数进行灵活调整。</p>
<p>对于每个框架，我们都有一些 API 可以调用 CUDA 进而制定设备为某个
GPU。以下内容大多参考自参考李沐的《动手学深度学习》（d2l）
中的讲解，链接在：<a
target="_blank" rel="noopener" href="http://zh.d2l.ai/chapter_deep-learning-computation/use-gpu.html">5.6.
GPU — 动手学深度学习 2.0.0-beta1 documentation (d2l.ai)</a></p>
<p>在 Linux 命令行下，我们可以使用这样的命令来查看当前的 GPU 设备。</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">$ <span class="token operator">!</span>nvidia-smi</code></pre>
<p>当你有一块 NVIDIA 的显卡并且安装好了 CUDA
时，这里就会显示你的显卡相应信息。例如，这是我在 Kaggle 上使用 P100 GPU
进行训练时所输出的内容。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2020.15.51.png"
alt="截屏2022-10-30 20.15.51" />
<figcaption aria-hidden="true">截屏2022-10-30 20.15.51</figcaption>
</figure>
<p>对于 PyTorch，可以使用 <code>torch.device()</code>
方法查看返回相应设备， 而对于 TensorFlow，可以使用
<code>tf.device()</code> 方法。d2l
中也定义了这样的函数，用于返回当前机器上可用的设备。</p>
<p>PyTorch：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">try_gpu</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#@save</span>
    <span class="token triple-quoted-string string">"""如果存在，则返回gpu(i)，否则返回cpu()"""</span>
    <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cuda:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cpu'</span><span class="token punctuation">)</span></code></pre>
<p>TensorFlow：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">try_gpu</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">#@save</span>
    <span class="token triple-quoted-string string">"""如果存在，则返回gpu(i)，否则返回cpu()"""</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>list_physical_devices<span class="token punctuation">(</span><span class="token string">'GPU'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> tf<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/GPU:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'/CPU:0'</span><span class="token punctuation">)</span></code></pre>
<p>我这里在为多卡训练做准备的情况下，实现了这样的过程用于指定设备：</p>
<pre class="language-python" data-language="python"><code class="language-python">USE_MULTI_GPU <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token keyword">if</span> USE_MULTI_GPU <span class="token keyword">and</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
    MULTI_GPU <span class="token operator">=</span> <span class="token boolean">True</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"CUDA_DEVICE_ORDER"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"PCI_BUS_ID"</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"CUDA_VISIBLE_DEVICES"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0, 1"</span>
    device_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    MULTI_GPU <span class="token operator">=</span> <span class="token boolean">False</span>

num_gpus <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">if</span> MULTI_GPU <span class="token keyword">else</span> <span class="token number">1</span>    
    
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span></code></pre>
<p>最终输出 cuda:0 ，证明我当前的设备指定为了我的第一块显卡。</p>
<p>第二，我们创建 <code>DataLoader</code> ，用于神经网络读取数据。</p>
<p>由于数据量很大，这里指定 batch size 为 <span
class="math inline">\(128\)</span> 。使用 <code>DataLoader</code>
类分别创建对于训练集、验证集和测试集的数据迭代器。</p>
<pre class="language-python" data-language="python"><code class="language-python">batch_size <span class="token operator">=</span> <span class="token number">128</span>
train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size <span class="token operator">*</span> num_gpus<span class="token punctuation">,</span>
                          shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                          drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
valid_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>valid_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size <span class="token operator">*</span> num_gpus<span class="token punctuation">,</span>
                          shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                          drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>test_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size <span class="token operator">*</span> num_gpus<span class="token punctuation">,</span>
                          shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                          drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<p>这里设定的一些参数也为了多卡训练做好了准备。</p>
<p>第三，我们搭建本题中使用的 LSTM 神经网络。我所使用的深度学习框架是
PyTorch，这里使用了 Netron 将网络结构进行可视化。（这个软件对
PyTorch可视化的支持还不是很友好）</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2021.13.00.png"
alt="截屏2022-10-30 21.13.00" />
<figcaption aria-hidden="true">截屏2022-10-30 21.13.00</figcaption>
</figure>
<p>使用 PyTorch 打印模型的输出可能更加清晰：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2021.14.10.png"
alt="截屏2022-10-30 21.14.10" />
<figcaption aria-hidden="true">截屏2022-10-30 21.14.10</figcaption>
</figure>
<p>使用 PyTorch 搭建本题使用的 LSTM
神经网络的代码如下，主要是声明各个层，并设定好前向传播函数。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">LSTM</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span>
                 num_layers<span class="token punctuation">,</span> output_size<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_size <span class="token operator">=</span> input_size
        self<span class="token punctuation">.</span>hidden_size <span class="token operator">=</span> hidden_size
        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> num_layers
        self<span class="token punctuation">.</span>output_size <span class="token operator">=</span> output_size
        self<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> batch_size
        self<span class="token punctuation">.</span>num_directions <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">,</span>
                            self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_size<span class="token punctuation">)</span>
<span class="token comment">#         self.reg = nn.Sequential(nn.Linear(self.hidden_size, self.hidden_size // 2),</span>
<span class="token comment">#                                  nn.ReLU(),</span>
<span class="token comment">#                                  nn.Linear(self.hidden_size // 2, self.output_size))</span>
<span class="token comment">#         self.fc1 = nn.Linear(self.hidden_size, self.hidden_size // 2)</span>
<span class="token comment">#         self.fc2 = nn.Linear(self.hidden_size // 2, self.hidden_size // 4)</span>
<span class="token comment">#         self.fc3 = nn.Linear(self.hidden_size // 4, self.output_size)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>
        h_0 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_directions <span class="token operator">*</span> self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span>
                          self<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        c_0 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_directions <span class="token operator">*</span> self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span>
                          self<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        output<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>X<span class="token punctuation">,</span> <span class="token punctuation">(</span>h_0<span class="token punctuation">,</span> c_0<span class="token punctuation">)</span><span class="token punctuation">)</span>
        o <span class="token operator">=</span> output<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token comment">#         pred = self.reg(o)</span>
        pred <span class="token operator">=</span> self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>o<span class="token punctuation">)</span>
        <span class="token keyword">return</span> pred</code></pre>
<p>这里只使用了单一的全连接层去接收 LSTM
的输出，即隐藏层门的状态，并输出最终的输出。可以从被注释掉的代码中看到，我还尝试了设定更复杂的回归器，由于函数的变化幅度很大，当时的想法是这种更复杂的回归方式是否能够更好的完成回归任务，但实验的结果是直接连接一个最简单的全连接层效果最好。</p>
<h3 id="开始训练">4.5 开始训练</h3>
<p>我们定义训练函数，这里使用 Adam
优化器进行优化，并在训练固定轮数后使用因子降低学习率。这里使用的模型选择策略是，首先在训练集上训练模型，得到损失后进行反向传播计算梯度。当这一个
epoch
中所有的训练数据全部输入模型进行训练后，开始在验证集上进行验证，最终取在验证集上表现最好的模型，将模型的参数进行保存。实现的代码如下。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> valid_loader<span class="token punctuation">,</span> path<span class="token punctuation">,</span> model_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'input_size'</span><span class="token punctuation">]</span>
    hidden_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'hidden_size'</span><span class="token punctuation">]</span>
    num_layers <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'num_layers'</span><span class="token punctuation">]</span>
    output_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'output_size'</span><span class="token punctuation">]</span>
    lr <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'learning_rate'</span><span class="token punctuation">]</span>
    wd <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span>
    step_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'step_size'</span><span class="token punctuation">]</span>
    gamma <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'gamma'</span><span class="token punctuation">]</span>
    epochs <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'epochs'</span><span class="token punctuation">]</span>
    train_loss<span class="token punctuation">,</span> valid_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    min_valid_loss <span class="token operator">=</span> np<span class="token punctuation">.</span>inf
    
    model <span class="token operator">=</span> LSTM<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> output_size<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token keyword">if</span> MULTI_GPU<span class="token punctuation">:</span>
        model <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>model<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    
    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>wd<span class="token punctuation">)</span>
    scheduler <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> step_size<span class="token operator">=</span>step_size<span class="token punctuation">,</span>
                                                gamma<span class="token operator">=</span>gamma<span class="token punctuation">)</span>
    <span class="token keyword">if</span> MULTI_GPU<span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
        scheduler <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>scheduler<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
        
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        train_ls<span class="token punctuation">,</span> valid_ls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> step<span class="token punctuation">,</span> <span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            X <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            y <span class="token operator">=</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            y_hat <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
<span class="token comment">#             if step == 0:</span>
<span class="token comment">#                 print(y_hat, y)</span>
            l <span class="token operator">=</span> loss<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
            train_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>l<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            l<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> step <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step &#123;&#125;, train loss &#123;:.6f&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span> l<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>train_ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> step<span class="token punctuation">,</span> <span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>valid_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            X <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            y <span class="token operator">=</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                y_hat <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
<span class="token comment">#                 print(y_hat)</span>
            l <span class="token operator">=</span> loss<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
            valid_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>l<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        valid_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>valid_ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> valid_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> min_valid_loss<span class="token punctuation">:</span>
            state <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'model'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> path<span class="token punctuation">)</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">,</span> model_path<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'New best performance... Save new model checkpoint.'</span><span class="token punctuation">)</span>
            min_valid_loss <span class="token operator">=</span> valid_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch [&#123;:d&#125;/&#123;:d&#125;], train loss &#123;:.6f&#125;, valid loss &#123;:.6f&#125;. Now best: &#123;:.6f&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> train_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> valid_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> min_valid_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> train_loss<span class="token punctuation">,</span> valid_loss</code></pre>
<p>经过实验后得出的近似最优超参如下：</p>
<pre class="language-python" data-language="python"><code class="language-python">params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'input_size'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token string">'hidden_size'</span><span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">,</span>
          <span class="token string">'output_size'</span><span class="token punctuation">:</span> predict_size<span class="token punctuation">,</span>
          <span class="token string">'num_layers'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> 
          <span class="token string">'learning_rate'</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
          <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span>
          <span class="token string">'step_size'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token string">'gamma'</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
          <span class="token string">'epochs'</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">&#125;</span></code></pre>
<p>调用函数开始训练，分别得到训练损失和验证损失，用以绘制图像。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_loss<span class="token punctuation">,</span> valid_loss <span class="token operator">=</span> train<span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> valid_loader<span class="token punctuation">,</span> <span class="token string">'model.pth'</span><span class="token punctuation">,</span> <span class="token string">'q1.pth'</span><span class="token punctuation">)</span></code></pre>
<p>绘制损失图像，用以观察模型的训练效果，判断模型是否欠拟合或过拟合。</p>
<pre class="language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> train_loss<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Train Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> valid_loss<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Valid Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Q1 LOSS Graph: BATCH_SIZE = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>batch_size<span class="token punctuation">&#125;</span></span><span class="token string">, LR = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>params<span class="token punctuation">[</span><span class="token string">'learning_rate'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___27_0.png"
alt="results_27_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_27_0</figcaption>
</figure>
<p>可以很明显的看到，在我们调整出的最有超参下，这个模型很好的进行了拟合，并没有出现欠拟合或者过拟合的情况。</p>
<h3 id="进行测试">4.6 进行测试</h3>
<p>接下来，在测试集上使用模型，并对其表现通过多种标准进行评估。首先定义和导入多种评价标准，对于回归问题，常见的评价指标有
MAE、MSE、MAPE 和 R2 score。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">mape</span><span class="token punctuation">(</span>truths<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">(</span>truths <span class="token operator">-</span> preds<span class="token punctuation">)</span> <span class="token operator">/</span> truths<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>

<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_absolute_error <span class="token keyword">as</span> MAE
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error <span class="token keyword">as</span> MSE
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> r2_score</code></pre>
<p>之后，定义测试函数，基本思路和训练函数中在验证集上使用模型类似。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> test_loader<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'input_size'</span><span class="token punctuation">]</span>
    hidden_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'hidden_size'</span><span class="token punctuation">]</span>
    num_layers <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'num_layers'</span><span class="token punctuation">]</span>
    output_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'output_size'</span><span class="token punctuation">]</span>
    truths<span class="token punctuation">,</span> preds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    model <span class="token operator">=</span> LSTM<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> output_size<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token keyword">if</span> MULTI_GPU<span class="token punctuation">:</span>
        model <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>model<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        X <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token keyword">for</span> each <span class="token keyword">in</span> y<span class="token punctuation">:</span>
            truths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>each<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            y_hat <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
            <span class="token keyword">for</span> each <span class="token keyword">in</span> y_hat<span class="token punctuation">:</span>
                preds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>each<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    truths<span class="token punctuation">,</span> preds <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>truths<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>preds<span class="token punctuation">)</span>
    truths <span class="token operator">=</span> test_scaler<span class="token punctuation">.</span>inverse_transform<span class="token punctuation">(</span>truths<span class="token punctuation">)</span>
    preds <span class="token operator">=</span> test_scaler<span class="token punctuation">.</span>inverse_transform<span class="token punctuation">(</span>preds<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'MAPE:'</span><span class="token punctuation">,</span> mape<span class="token punctuation">(</span>truths<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'MAE:'</span><span class="token punctuation">,</span> MAE<span class="token punctuation">(</span>truths<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'MSE:'</span><span class="token punctuation">,</span> MSE<span class="token punctuation">(</span>truths<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'R2 Score:'</span><span class="token punctuation">,</span> r2_score<span class="token punctuation">(</span>truths<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> truths<span class="token punctuation">,</span> preds</code></pre>
<p>在测试过程中，打印了对于当前模型的评价指标分数。</p>
<pre class="language-none"><code class="language-none">MAPE: 5.268349125981331
MAE: 10297.624
MSE: 190067630.0
R2 Score: 0.766958621277085</code></pre>
<p>单纯的从 MAE 来看，这一模型的回归效果还是比较好的。在实验过程中，MAE
数量级基本控制在区间 <span class="math inline">\([9000, 15000]\)</span>
。上面的数据是在撰写本文时的输出数据，由于初始的 <span
class="math inline">\(h_0,c_0\)</span>
两个状态均是随机得到的，每次运行训练的结果也可能大相径庭。</p>
<p>绘制测试集上数据的图像，这里加入了一点平滑处理。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>interpolate <span class="token keyword">import</span> make_interp_spline

x <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>truths<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
x_smth <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">)</span>
truths_smth <span class="token operator">=</span> make_interp_spline<span class="token punctuation">(</span>x<span class="token punctuation">,</span> truths<span class="token punctuation">)</span><span class="token punctuation">(</span>x_smth<span class="token punctuation">)</span>
preds_smth <span class="token operator">=</span> make_interp_spline<span class="token punctuation">(</span>x<span class="token punctuation">,</span> preds<span class="token punctuation">)</span><span class="token punctuation">(</span>x_smth<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_smth<span class="token punctuation">,</span> truths_smth<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'g'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Truth'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_smth<span class="token punctuation">,</span> preds_smth<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Predict'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Truth v.s. Preds on Test Dataset'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___31_0.png"
alt="results_31_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_31_0</figcaption>
</figure>
<p>可以看到，模型对于函数抖动趋势的学习还是非常好的，但在某些毛刺上有这很不好的表现。当然，这是在预料之中的。</p>
<h3 id="完成预测">4.7 完成预测</h3>
<p>首先读入需要预测的数据表，以供后文填充使用。</p>
<pre class="language-python" data-language="python"><code class="language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'/kaggle/input/electrical-energy-load/test/1.csv'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'gb2312'</span><span class="token punctuation">)</span></code></pre>
<p>编写函数，完成对于文件中要求时间的预测。这里预测的输入采用滑动窗口策略，每当预测出一个值后，将窗口中最早的数据剔除，在窗口中加入最新预测的数据，重新将新窗口创建为张量，作为下一次的输入。</p>
<p>另外，由于读取编码的问题，在函数中也修正了列名和列的数据类型。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'input_size'</span><span class="token punctuation">]</span>
    hidden_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'hidden_size'</span><span class="token punctuation">]</span>
    num_layers <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'num_layers'</span><span class="token punctuation">]</span>
    output_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'output_size'</span><span class="token punctuation">]</span>

    model <span class="token operator">=</span> LSTM<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> output_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token keyword">if</span> MULTI_GPU<span class="token punctuation">:</span>
        model <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>model<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    X <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>train_bin<span class="token punctuation">[</span><span class="token operator">-</span>window_size<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
    data_iter <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    train_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>train_scaler<span class="token punctuation">.</span>inverse_transform<span class="token punctuation">(</span>train_bin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span>window_size<span class="token punctuation">:</span><span class="token punctuation">]</span>
    maxv<span class="token punctuation">,</span> minv <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>train_list<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>train_list<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    label <span class="token operator">=</span> <span class="token string">'总有功功率（kw）'</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> data_iter<span class="token punctuation">:</span>
                X <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                y_hat <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
                val <span class="token operator">=</span> y_hat<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>maxv <span class="token operator">-</span> minv<span class="token punctuation">)</span> <span class="token operator">+</span> minv
        df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>i<span class="token punctuation">,</span> label<span class="token punctuation">]</span> <span class="token operator">=</span> val
        <span class="token keyword">del</span> train_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        train_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        maxv<span class="token punctuation">,</span> minv <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>train_list<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>train_list<span class="token punctuation">)</span>
        X <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>train_list<span class="token punctuation">)</span> <span class="token operator">-</span> minv<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxv <span class="token operator">-</span> minv<span class="token punctuation">)</span><span class="token punctuation">]</span>
        X <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
        data <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        data_iter <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'数据时间'</span><span class="token punctuation">,</span> <span class="token string">'总有功功率（kw）'</span><span class="token punctuation">]</span>
    df<span class="token punctuation">[</span><span class="token string">'数据时间'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'数据时间'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'fill_1.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre>
<p>执行该函数进行预测，使用的仍然是上文训练出模型的参数。填充好的表被存储到
<code>fill_1.csv</code> 中。</p>
<pre class="language-python" data-language="python"><code class="language-python">predict<span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token string">'model.pth'</span><span class="token punctuation">)</span></code></pre>
<h2 id="问题一2的实现">5 问题一（2）的实现</h2>
<p>这一问本质上是一个多目标回归，我将问题转化成了分别对于每日最大值及其出现时间、每日最小值及其出现时间的预测问题。</p>
<h3 id="数据准备">5.1 数据准备</h3>
<p>对于这一问题，题目要求的时间频度为一天，所以我们应当对上一问中填充好的
15 分钟频度的数据进行分组聚合。同时，由于表 3
中给出的气象数据也是时间频度为一天的数据，我们也应当考虑是否能够将其处理后拼接到表中作为特征同时进行输入。</p>
<p>首先处理 15
分钟频度数据，按照最大值、最小值规则聚合，处理到一天频度。首先读入上一问中填充好的数据。</p>
<pre class="language-python" data-language="python"><code class="language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'15min_freq.csv'</span><span class="token punctuation">)</span></code></pre>
<p>将日期进行分解，便于后面进行一系列的处理。并且，增加一个特征
<code>Tick</code> ，该特征定义如下 <span class="math display">\[
Tick:=4\times Hour+Minute
\]</span>
这一特征是为了后面训练时减少维度，同时也把时间特征转化为一个数值特征。</p>
<pre class="language-python" data-language="python"><code class="language-python">df<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'Year'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>year
df<span class="token punctuation">[</span><span class="token string">'Month'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>month
df<span class="token punctuation">[</span><span class="token string">'Day'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>day
df<span class="token punctuation">[</span><span class="token string">'Hour'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>hour
df<span class="token punctuation">[</span><span class="token string">'Minute'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>minute
df<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Hour'</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'Minute'</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token number">15</span>
df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2022.32.50.png"
alt="截屏2022-10-30 22.32.50" />
<figcaption aria-hidden="true">截屏2022-10-30 22.32.50</figcaption>
</figure>
<p>之后，根据日期（天）和最大最小的规则进行聚合，关于如何进行分组聚合已经在第五次实验中解释得很清除了，这里就不再进行阐述了。</p>
<pre class="language-python" data-language="python"><code class="language-python">groups <span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Year'</span><span class="token punctuation">,</span> <span class="token string">'Month'</span><span class="token punctuation">,</span> <span class="token string">'Day'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">,</span> <span class="token string">'Year'</span><span class="token punctuation">,</span> <span class="token string">'Month'</span><span class="token punctuation">,</span> <span class="token string">'Day'</span><span class="token punctuation">,</span> <span class="token string">'Hour'</span><span class="token punctuation">,</span> <span class="token string">'Minute'</span><span class="token punctuation">]</span>
data_daily_max <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns<span class="token punctuation">)</span>
data_daily_min <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns<span class="token punctuation">)</span>
<span class="token keyword">for</span> group <span class="token keyword">in</span> groups<span class="token punctuation">:</span>
    _<span class="token punctuation">,</span> meta <span class="token operator">=</span> group
    max_row <span class="token operator">=</span> meta<span class="token punctuation">[</span>meta<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span> <span class="token operator">==</span> meta<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    min_row <span class="token operator">=</span> meta<span class="token punctuation">[</span>meta<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span> <span class="token operator">==</span> meta<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    data_daily_max <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>data_daily_max<span class="token punctuation">,</span> max_row<span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    data_daily_min <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>data_daily_min<span class="token punctuation">,</span> min_row<span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<pre class="language-python" data-language="python"><code class="language-python">data_daily_max<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2022.34.37.png"
alt="截屏2022-10-30 22.34.37" />
<figcaption aria-hidden="true">截屏2022-10-30 22.34.37</figcaption>
</figure>
<pre class="language-python" data-language="python"><code class="language-python">data_daily_min<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2022.34.54.png"
alt="截屏2022-10-30 22.34.54" />
<figcaption aria-hidden="true">截屏2022-10-30 22.34.54</figcaption>
</figure>
<p>分别对功率 <code>Power</code> 和时刻 <code>Tick</code>
进行可视化，观察其大致分布。</p>
<pre class="language-python" data-language="python"><code class="language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_daily_max<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> data_daily_max<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'g'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Max'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> data_daily_min<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Min'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Daily Power Max &amp; Min'</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___38_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<pre class="language-python" data-language="python"><code class="language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data_daily_max<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> data_daily_max<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'g'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Max'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> data_daily_min<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Min'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Daily Max and Min Time (As Tick)'</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___39_1.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>在处理过的两表中增加一列日期列，以便后文在图上标注相应日期，这里的日期列由之前的日期分解特征重新组合而成。</p>
<pre class="language-python" data-language="python"><code class="language-python">data_daily_max<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>data_daily_max<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Year'</span><span class="token punctuation">,</span> <span class="token string">'Month'</span><span class="token punctuation">,</span> <span class="token string">'Day'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
data_daily_min<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>data_daily_min<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Year'</span><span class="token punctuation">,</span> <span class="token string">'Month'</span><span class="token punctuation">,</span> <span class="token string">'Day'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>之后，对天气数据进行处理。首先读入天气数据，并查看数据的形状。</p>
<pre class="language-python" data-language="python"><code class="language-python">weather_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../input/electrical-energy-load/train/3.csv'</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2023.04.54.png"
alt="截屏2022-10-30 23.04.54" />
<figcaption aria-hidden="true">截屏2022-10-30 23.04.54</figcaption>
</figure>
<p>将列进行重命名，并将字符串形式的日期通过一系列转换变化为 pandas
的时间类型。</p>
<pre class="language-python" data-language="python"><code class="language-python">weather_data<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'Weather'</span><span class="token punctuation">,</span> <span class="token string">'HighTemp'</span><span class="token punctuation">,</span> <span class="token string">'LowTemp'</span><span class="token punctuation">,</span> <span class="token string">'DayWind'</span><span class="token punctuation">,</span> <span class="token string">'NightWind'</span><span class="token punctuation">]</span>
weather_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'年'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'月'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'日'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>weather_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2023.05.53.png"
alt="截屏2022-10-30 23.05.53" />
<figcaption aria-hidden="true">截屏2022-10-30 23.05.53</figcaption>
</figure>
<p>通过字符串替换和类型转换，将两列温度列转化为整型特征。</p>
<pre class="language-python" data-language="python"><code class="language-python">weather_data<span class="token punctuation">[</span><span class="token string">'HighTemp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'HighTemp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">[</span><span class="token string">'LowTemp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'LowTemp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">[</span><span class="token string">'HighTemp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'HighTemp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">[</span><span class="token string">'LowTemp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'LowTemp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-30%2023.06.38.png"
alt="截屏2022-10-30 23.06.38" />
<figcaption aria-hidden="true">截屏2022-10-30 23.06.38</figcaption>
</figure>
<p>之后，我们希望处理 <code>Weather</code>
列。观察到这一列实际上是由两个值组成，代表了一天的两个天气，但两个天气可能相同也可能不同。所以，这一列的处理有一定的思维含量。基本的思路是首先将两个天气分裂成两列，之后，使用统一的编码对两列进行编码，并要求将其转化为同一特征，最后，使用独热编码转换成实际可用的特征，拼接到原表当中。</p>
<p>首先对天气进行分裂，观察到实际上表中的两个天气都是以 <code>/</code>
作为分割，于是有如下的实现方式。</p>
<pre class="language-python" data-language="python"><code class="language-python">weather_data<span class="token punctuation">[</span><span class="token string">'Weather1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'Weather'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">[</span><span class="token string">'Weather2'</span><span class="token punctuation">]</span> <span class="token operator">=</span> weather_data<span class="token punctuation">[</span><span class="token string">'Weather'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
weather_data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Weather'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<p>之后，进行编码的处理过程。我们的编码过程应当根据两列出现的属性值集合的并集进行编码，即将两列的取值情况提出形成集合，取并集获得两列中出现的所有天气可能，之后根据这些天气可能统一进行编码，再根据实际的天气情况还原到表中。幸运的是，sklearn
的 <code>OneHotEncoder</code>
能够帮助这种思路的实现，只需要稍作添加。总体的实现代码是下面这样。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> OneHotEncoder

weather_encoder <span class="token operator">=</span> OneHotEncoder<span class="token punctuation">(</span>handle_unknown<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
weather_encoder<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>weather_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Weather1'</span><span class="token punctuation">,</span> <span class="token string">'Weather2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>
mat <span class="token operator">=</span> weather_encoder<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>weather_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Weather1'</span><span class="token punctuation">,</span> <span class="token string">'Weather2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span>toarray<span class="token punctuation">(</span><span class="token punctuation">)</span>
feature_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>weather_encoder<span class="token punctuation">.</span>categories_<span class="token punctuation">)</span><span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>

columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'Weather1'</span><span class="token punctuation">,</span> <span class="token string">'Weather2'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> val <span class="token keyword">in</span> weather_data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        columns<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'&#123;&#125;_&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
onehot_codes <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token operator">=</span>mat<span class="token punctuation">,</span> columns<span class="token operator">=</span>columns<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
weather_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>weather_data<span class="token punctuation">,</span> onehot_codes<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<p>下面我们逐一进行解释。首先是创建一个独热编码编码器，并规定这一编码器对于未知类型进行忽略。</p>
<pre class="language-python" data-language="python"><code class="language-python">weather_encoder <span class="token operator">=</span> OneHotEncoder<span class="token punctuation">(</span>handle_unknown<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span></code></pre>
<p>之后，让这一编码器 “适应”
天气数据，这个类的强大之处就在于，它可以自己自动进行筛选、并集和赋值的过程。于是有下面这一句：</p>
<pre class="language-python" data-language="python"><code class="language-python">weather_encoder<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>weather_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Weather1'</span><span class="token punctuation">,</span> <span class="token string">'Weather2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span></code></pre>
<p>之后，生成独热编码矩阵。这一矩阵的生成是基于原始的两列天气列，并且基于编码器所创建好的类别编码进行。</p>
<pre class="language-python" data-language="python"><code class="language-python">mat <span class="token operator">=</span> weather_encoder<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>weather_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Weather1'</span><span class="token punctuation">,</span> <span class="token string">'Weather2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span>toarray<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>创建编码器所适应的数据中所有类别的列表。</p>
<pre class="language-python" data-language="python"><code class="language-python">feature_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>weather_encoder<span class="token punctuation">.</span>categories_<span class="token punctuation">)</span><span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>那么现在，我们就得到了合成带天气特征表所需要的全部元素了，接下来就是合成表的过程。</p>
<p>首先创建独热编码的所有列名。通过 <code>unique()</code>
方法，我们能够获取所有的取值可能。</p>
<pre class="language-python" data-language="python"><code class="language-python">columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'Weather1'</span><span class="token punctuation">,</span> <span class="token string">'Weather2'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> val <span class="token keyword">in</span> weather_data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        columns<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'&#123;&#125;_&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>之后，将独热编码矩阵和原矩阵合并。</p>
<pre class="language-python" data-language="python"><code class="language-python">onehot_codes <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token operator">=</span>mat<span class="token punctuation">,</span> columns<span class="token operator">=</span>columns<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
weather_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>weather_data<span class="token punctuation">,</span> onehot_codes<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<p>这样这一过程就完成了。</p>
<p>之后，我们对风力数据进行处理，可以发现风力数据也是这种类别数据，我们依照和上面完全一致的方式进行处理。</p>
<pre class="language-python" data-language="python"><code class="language-python">wind_encoder <span class="token operator">=</span> OneHotEncoder<span class="token punctuation">(</span>handle_unknown<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
wind_encoder<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>weather_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'DayWind'</span><span class="token punctuation">,</span> <span class="token string">'NightWind'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span>
mat <span class="token operator">=</span> wind_encoder<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>weather_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'DayWind'</span><span class="token punctuation">,</span> <span class="token string">'NightWind'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span>toarray<span class="token punctuation">(</span><span class="token punctuation">)</span>
feature_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>wind_encoder<span class="token punctuation">.</span>categories_<span class="token punctuation">)</span><span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span>

columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'DayWind'</span><span class="token punctuation">,</span> <span class="token string">'NightWind'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> val <span class="token keyword">in</span> weather_data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        columns<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'&#123;&#125;_&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span>

onehot_codes <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token operator">=</span>mat<span class="token punctuation">,</span> columns<span class="token operator">=</span>columns<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
weather_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>weather_data<span class="token punctuation">,</span> onehot_codes<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<p>最后，我们将已经转换为数值特征和独热编码的没有用的列删掉。在观察数据是发现，有一些行是完全一致但重复的，我们根据日期一列将重复值删除。</p>
<pre class="language-python" data-language="python"><code class="language-python">weather_data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'DayWind'</span><span class="token punctuation">,</span> <span class="token string">'NightWind'</span><span class="token punctuation">,</span> <span class="token string">'Weather1'</span><span class="token punctuation">,</span> <span class="token string">'Weather2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
weather_data <span class="token operator">=</span> weather_data<span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>查看一下当前数据的形状。</p>
<pre class="language-python" data-language="python"><code class="language-python">weather_data<span class="token punctuation">.</span>shape</code></pre>
<p>得到输出：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">(</span><span class="token number">1339</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">)</span></code></pre>
<p>我们根据日期列将气象数据和前面得到的最值数据进行拼接，得到最终的数据。首先将两表按照日期进行拼接。</p>
<pre class="language-python" data-language="python"><code class="language-python">daily_max_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>data_daily_max<span class="token punctuation">,</span> weather_data<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'Date'</span><span class="token punctuation">)</span>
daily_min_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>data_daily_min<span class="token punctuation">,</span> weather_data<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'Date'</span><span class="token punctuation">)</span></code></pre>
<p>之后，设定两表的索引为日期 <code>Date</code>
，并删除掉一些没有用的列。</p>
<pre class="language-python" data-language="python"><code class="language-python">daily_max_data<span class="token punctuation">.</span>index <span class="token operator">=</span> daily_max_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span>
daily_min_data<span class="token punctuation">.</span>index <span class="token operator">=</span> daily_min_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span>
daily_max_data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token string">'Year'</span><span class="token punctuation">,</span> <span class="token string">'Month'</span><span class="token punctuation">,</span> <span class="token string">'Day'</span><span class="token punctuation">,</span> <span class="token string">'Hour'</span><span class="token punctuation">,</span> <span class="token string">'Minute'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
daily_min_data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token string">'Year'</span><span class="token punctuation">,</span> <span class="token string">'Month'</span><span class="token punctuation">,</span> <span class="token string">'Day'</span><span class="token punctuation">,</span> <span class="token string">'Hour'</span><span class="token punctuation">,</span> <span class="token string">'Minute'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<p>我们之前观察到，数据存在许多突变点和毛刺，为训练效果更好，我这里对数据进行了平滑处理，使用的方法是
Savitzky-Golay 滤波器，通过 <code>scipy.signal.savgol_filter</code>
类实现。但应当注意的是，我们应当只对训练数据做平滑化，所以在平滑化之前，我首先分割了训练集、验证集和测试集。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>signal <span class="token keyword">import</span> savgol_filter <span class="token keyword">as</span> SGFilt

train_bin_max<span class="token punctuation">,</span> valid_bin_max<span class="token punctuation">,</span> test_bin_max <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>daily_max_data<span class="token punctuation">,</span> <span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span>
train_bin_min<span class="token punctuation">,</span> valid_bin_min<span class="token punctuation">,</span> test_bin_min <span class="token operator">=</span> split_dataset<span class="token punctuation">(</span>daily_min_data<span class="token punctuation">,</span> <span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span>

w<span class="token punctuation">,</span> p <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span>
train_bin_max<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span> <span class="token operator">=</span> SGFilt<span class="token punctuation">(</span>train_bin_max<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
train_bin_max<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span> <span class="token operator">=</span> SGFilt<span class="token punctuation">(</span>train_bin_max<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
train_bin_min<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span> <span class="token operator">=</span> SGFilt<span class="token punctuation">(</span>train_bin_min<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
train_bin_min<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span> <span class="token operator">=</span> SGFilt<span class="token punctuation">(</span>train_bin_min<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> p<span class="token punctuation">)</span></code></pre>
<p>最后，我们想要对数据进行归一化处理。由于我们只想要每日最大值（或）和它的出现时间，所以我们在反归一化时必须要记录相应列的最值。我们首先记录最值到不同变量中。</p>
<pre class="language-python" data-language="python"><code class="language-python">test_max_power_range <span class="token operator">=</span> <span class="token punctuation">[</span>test_bin_max<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test_bin_max<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
test_max_tick_range <span class="token operator">=</span> <span class="token punctuation">[</span>test_bin_max<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test_bin_max<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

test_min_power_range <span class="token operator">=</span> <span class="token punctuation">[</span>test_bin_min<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test_bin_min<span class="token punctuation">[</span><span class="token string">'Power'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
test_min_tick_range <span class="token operator">=</span> <span class="token punctuation">[</span>test_bin_min<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> test_bin_min<span class="token punctuation">[</span><span class="token string">'Tick'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre>
<p>之后，对两表产生的训练集、验证集和测试集分别进行归一化处理。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">scaling</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> scaler<span class="token punctuation">,</span> scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>data<span class="token punctuation">)</span></code></pre>
<pre class="language-python" data-language="python"><code class="language-python">train_max_scaler<span class="token punctuation">,</span> train_max <span class="token operator">=</span> scaling<span class="token punctuation">(</span>train_bin_max<span class="token punctuation">)</span>
train_min_scaler<span class="token punctuation">,</span> train_min <span class="token operator">=</span> scaling<span class="token punctuation">(</span>train_bin_min<span class="token punctuation">)</span>
valid_max_scaler<span class="token punctuation">,</span> valid_max <span class="token operator">=</span> scaling<span class="token punctuation">(</span>valid_bin_max<span class="token punctuation">)</span>
valid_min_scaler<span class="token punctuation">,</span> valid_min <span class="token operator">=</span> scaling<span class="token punctuation">(</span>valid_bin_min<span class="token punctuation">)</span>
test_max_scaler<span class="token punctuation">,</span> test_max <span class="token operator">=</span> scaling<span class="token punctuation">(</span>test_bin_max<span class="token punctuation">)</span>
test_min_scaler<span class="token punctuation">,</span> test_min <span class="token operator">=</span> scaling<span class="token punctuation">(</span>test_bin_min<span class="token punctuation">)</span></code></pre>
<h3 id="对每日最大值的解决">5.2 对每日最大值的解决</h3>
<p>这里我对两种解决方案进行了分别在每日最大值问题上进行了实验，并试图调节超参到尽可能最优。两种方案如下：</p>
<ol type="1">
<li><p>使用多输出 LSTM 进行一次训练</p>
<p>该方案使用多输出的 LSTM 进行训练，在网络中间采用同一个 LSTM
，但将两个输入导入到不同的线性层当中，针对不同的目标进行回归。在网络中计算损失时，损失等于每一个需要被预测的数据项的损失之和，并使用该损失进行反向传播计算梯度。在测试集上和验证集上，损失也遵循这样的计算方式。</p></li>
<li><p>使用单输出 LSTM 分别进行训练</p>
<p>该方案对于每一个回归目标使用同一单输出 LSTM
网络进行分别训练，旨在对于不同的目标学习不同的参数，以使得在同一批特征输入下针对不同目标的回归能达到效果最优</p></li>
</ol>
<p>经过试验，在本问题的解决上第一种方案相对更优。下面分别对以上两种方案的实现进行阐述。</p>
<h4 id="多输出-lstm">5.2.1 多输出 LSTM</h4>
<p>首先准备输入输出数据，定义如下的预处理函数。该函数针对传入数据进行滑动窗口切分，生成
<span class="math inline">\(X\)</span> 和 <span
class="math inline">\(y\)</span> 。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">preprocessing</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> predict_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    X<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> window_size <span class="token operator">-</span> predict_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        X<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> window_size<span class="token punctuation">]</span><span class="token punctuation">)</span>
        y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> window_size<span class="token punctuation">:</span>i <span class="token operator">+</span> window_size <span class="token operator">+</span> predict_size<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    X <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> X<span class="token punctuation">,</span> y</code></pre>
<p>必须注意的是，这里对于 <span class="math inline">\(y\)</span>
的处理并不能和第一小文章宏的完全一致。我们应当把取出来的数据重塑成 <span
class="math inline">\((2,L)\)</span> 大小的向量，其中 <span
class="math inline">\(L\)</span> 是预测窗口宽度。</p>
<p>对于训练集、验证集和测试集分别进行滑动窗口切分处理，调用该函数。</p>
<pre class="language-python" data-language="python"><code class="language-python">window_size<span class="token punctuation">,</span> predict_size <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">1</span>

X_train<span class="token punctuation">,</span> y_train <span class="token operator">=</span> preprocessing<span class="token punctuation">(</span>train_max<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> predict_size<span class="token punctuation">)</span>
X_valid<span class="token punctuation">,</span> y_valid <span class="token operator">=</span> preprocessing<span class="token punctuation">(</span>valid_max<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> predict_size<span class="token punctuation">)</span>
X_test<span class="token punctuation">,</span> y_test <span class="token operator">=</span> preprocessing<span class="token punctuation">(</span>test_max<span class="token punctuation">,</span> window_size<span class="token punctuation">,</span> predict_size<span class="token punctuation">)</span></code></pre>
<p>根据以上生成的 <span class="math inline">\(X\)</span> 和 <span
class="math inline">\(y\)</span> ，生成 <code>TensorDataset</code> 和
<code>DataLoader</code> 。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_data <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
valid_data <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>X_valid<span class="token punctuation">,</span> y_valid<span class="token punctuation">)</span>
test_data <span class="token operator">=</span> TensorDataset<span class="token punctuation">(</span>X_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span></code></pre>
<p>由于数据量小，这里设定 batch size 为 <span
class="math inline">\(16\)</span> 。</p>
<pre class="language-python" data-language="python"><code class="language-python">batch_size <span class="token operator">=</span> <span class="token number">16</span>
train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size <span class="token operator">*</span> num_gpus<span class="token punctuation">,</span>
                          shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                          drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
valid_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>valid_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size <span class="token operator">*</span> num_gpus<span class="token punctuation">,</span>
                          shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                          drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>test_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size <span class="token operator">*</span> num_gpus<span class="token punctuation">,</span>
                          shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                          drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<p>输出训练集、验证集和测试集张量的形状，以确保和输入输出所要求的形状完全对应。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Train set:'</span><span class="token punctuation">,</span> X_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> y_train<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Valid set:'</span><span class="token punctuation">,</span> X_valid<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> y_valid<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Test set:'</span><span class="token punctuation">,</span> X_test<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> y_test<span class="token punctuation">.</span>shape<span class="token punctuation">)</span></code></pre>
<p>得到输出：</p>
<pre class="language-python" data-language="python"><code class="language-python">Train <span class="token builtin">set</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">922</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">]</span><span class="token punctuation">)</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">922</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Valid <span class="token builtin">set</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">118</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">]</span><span class="token punctuation">)</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">118</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Test <span class="token builtin">set</span><span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">254</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">]</span><span class="token punctuation">)</span> torch<span class="token punctuation">.</span>Size<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">254</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>定义多输出 LSTM 网络。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">LSTM_multi</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span>
                 num_layers<span class="token punctuation">,</span> output_size<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_size <span class="token operator">=</span> input_size
        self<span class="token punctuation">.</span>hidden_size <span class="token operator">=</span> hidden_size
        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> num_layers
        self<span class="token punctuation">.</span>output_size <span class="token operator">=</span> output_size
        self<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> batch_size
        self<span class="token punctuation">.</span>num_directions <span class="token operator">=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">,</span>
                            self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment">#         self.reg_pred = nn.Sequential(nn.Linear(self.hidden_size, self.hidden_size // 2),</span>
<span class="token comment">#                                       nn.ReLU(),</span>
<span class="token comment">#                                       nn.Linear(self.hidden_size // 2, self.hidden_size // 4),</span>
<span class="token comment">#                                       nn.ReLU(),</span>
<span class="token comment">#                                       nn.Linear(self.hidden_size // 4, self.output_size))</span>
<span class="token comment">#         self.reg_time = nn.Sequential(nn.Linear(self.hidden_size, self.hidden_size // 2),</span>
<span class="token comment">#                                       nn.ReLU(),</span>
<span class="token comment">#                                       nn.Linear(self.hidden_size // 2, self.hidden_size // 4),</span>
<span class="token comment">#                                       nn.ReLU(),</span>
<span class="token comment">#                                       nn.Linear(self.hidden_size // 4, self.output_size))</span>
        self<span class="token punctuation">.</span>linear_pred <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>linear_time <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_size<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>
        h_0 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_directions <span class="token operator">*</span> self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span>
                          self<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        c_0 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_directions <span class="token operator">*</span> self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span>
                          self<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>hidden_size<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        output<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span>X<span class="token punctuation">,</span> <span class="token punctuation">(</span>h_0<span class="token punctuation">,</span> c_0<span class="token punctuation">)</span><span class="token punctuation">)</span>
        o <span class="token operator">=</span> output<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        pred<span class="token punctuation">,</span> time <span class="token operator">=</span> self<span class="token punctuation">.</span>linear_pred<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>linear_time<span class="token punctuation">(</span>o<span class="token punctuation">)</span>
<span class="token comment">#         pred, time = self.reg_pred(o), self.reg_time(o)</span>
        preds <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>pred<span class="token punctuation">,</span> time<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> preds</code></pre>
<p>在类中，对于功率预测的线性层和时间预测的线性层是独立的两个全连接层。另外，你可以看到，这里我也进行了是否使用更复杂的回归器的实验，结果和前一问中一致，使用更复杂的回归器只会使得结果变差。</p>
<p>设定该网络的超参如下，这是经过很多次实验后得到的最优超参。</p>
<pre class="language-python" data-language="python"><code class="language-python">params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'input_size'</span><span class="token punctuation">:</span> X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">'hidden_size'</span><span class="token punctuation">:</span> <span class="token number">512</span><span class="token punctuation">,</span>
          <span class="token string">'output_size'</span><span class="token punctuation">:</span> predict_size<span class="token punctuation">,</span>
          <span class="token string">'num_outputs'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token string">'num_layers'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> 
          <span class="token string">'learning_rate'</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
          <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token string">'step_size'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
          <span class="token string">'gamma'</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
          <span class="token string">'epochs'</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">&#125;</span></code></pre>
<p>定义训练函数如下，和前一问定义的训练函数的唯一不同就是在损失的计算上，由于我们使用了多输出的
LSTM，损失应该等于每一项损失的累计。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> valid_loader<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'input_size'</span><span class="token punctuation">]</span>
    hidden_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'hidden_size'</span><span class="token punctuation">]</span>
    num_layers <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'num_layers'</span><span class="token punctuation">]</span>
    output_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'output_size'</span><span class="token punctuation">]</span>
    lr <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'learning_rate'</span><span class="token punctuation">]</span>
    wd <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'weight_decay'</span><span class="token punctuation">]</span>
    step_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'step_size'</span><span class="token punctuation">]</span>
    gamma <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'gamma'</span><span class="token punctuation">]</span>
    epochs <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'epochs'</span><span class="token punctuation">]</span>
    num_outputs <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'num_outputs'</span><span class="token punctuation">]</span>
    train_loss<span class="token punctuation">,</span> valid_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    min_valid_loss <span class="token operator">=</span> np<span class="token punctuation">.</span>inf
    
    model <span class="token operator">=</span> LSTM_multi<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> output_size<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token keyword">if</span> MULTI_GPU<span class="token punctuation">:</span>
        model <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>model<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    
    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>wd<span class="token punctuation">)</span>
    scheduler <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> step_size<span class="token operator">=</span>step_size<span class="token punctuation">,</span>
                                                gamma<span class="token operator">=</span>gamma<span class="token punctuation">)</span>
    <span class="token keyword">if</span> MULTI_GPU<span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
        scheduler <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>scheduler<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
        
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        train_ls<span class="token punctuation">,</span> valid_ls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> step<span class="token punctuation">,</span> <span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            X <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            y <span class="token operator">=</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            y_hat <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
            l <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                l <span class="token operator">+=</span> loss<span class="token punctuation">(</span>y_hat<span class="token punctuation">[</span>k<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            l <span class="token operator">/=</span> num_outputs
            train_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>l<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            l<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> step <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Step &#123;&#125;, train loss &#123;:.6f&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span> l<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>train_ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> step<span class="token punctuation">,</span> <span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>valid_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            X <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            y <span class="token operator">=</span> y<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                y_hat <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
            l <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                l <span class="token operator">+=</span> loss<span class="token punctuation">(</span>y_hat<span class="token punctuation">[</span>k<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            l <span class="token operator">/=</span> num_outputs
            valid_ls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>l<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        valid_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>valid_ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> valid_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> min_valid_loss<span class="token punctuation">:</span>
            state <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'model'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>state<span class="token punctuation">,</span> path<span class="token punctuation">)</span>
            min_valid_loss <span class="token operator">=</span> valid_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch [&#123;:d&#125;/&#123;:d&#125;], train loss &#123;:.6f&#125;, valid loss &#123;:.6f&#125;. Now best: &#123;:.6f&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epochs<span class="token punctuation">,</span> train_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> valid_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> min_valid_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> train_loss<span class="token punctuation">,</span> valid_loss</code></pre>
<p>调用该函数开始训练，并返回其训练损失和验证损失。</p>
<pre class="language-python" data-language="python"><code class="language-python">train_loss<span class="token punctuation">,</span> valid_loss <span class="token operator">=</span> train<span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_loader<span class="token punctuation">,</span> valid_loader<span class="token punctuation">,</span> <span class="token string">'model_max.pth'</span><span class="token punctuation">)</span></code></pre>
<p>绘制损失的图像，观察两曲线的大致位置关系。</p>
<pre class="language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> train_loss<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Train Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> valid_loss<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Valid Loss'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Q2 LOSS Graph: BATCH_SIZE = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>batch_size<span class="token punctuation">&#125;</span></span><span class="token string">, LR = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>params<span class="token punctuation">[</span><span class="token string">'learning_rate'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___73_0.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>可以看到，虽然存在一些抖动，验证损失曲线基本是在训练损失曲线的上方，模型拟合的效果还是比较好的。</p>
<p>之后，我们定义测试函数，欲观察模型在测试集上的表现。测试函数的实现方式也是参照验证集的实现方式，这里对于功率预测和时间预测分别计算了每个评价指标，并放在了一个
DataFrame 当中。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> test_loader<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'input_size'</span><span class="token punctuation">]</span>
    hidden_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'hidden_size'</span><span class="token punctuation">]</span>
    num_layers <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'num_layers'</span><span class="token punctuation">]</span>
    output_size <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'output_size'</span><span class="token punctuation">]</span>
    num_outputs <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'num_outputs'</span><span class="token punctuation">]</span>
    truths<span class="token punctuation">,</span> preds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    model <span class="token operator">=</span> LSTM_multi<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> output_size<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token keyword">if</span> MULTI_GPU<span class="token punctuation">:</span>
        model <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>model<span class="token punctuation">,</span> device_ids<span class="token operator">=</span>device_ids<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> X<span class="token punctuation">,</span> y <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        X <span class="token operator">=</span> X<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            truths<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>extend<span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            y_hat <span class="token operator">=</span> model<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
            <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                preds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>extend<span class="token punctuation">(</span>y_hat<span class="token punctuation">[</span>k<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    truths<span class="token punctuation">,</span> preds <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>truths<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>preds<span class="token punctuation">)</span>
    <span class="token keyword">for</span> vals <span class="token keyword">in</span> <span class="token punctuation">[</span>truths<span class="token punctuation">,</span> preds<span class="token punctuation">]</span><span class="token punctuation">:</span>
        vals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> vals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>test_max_power_range<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> test_max_power_range<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> test_max_power_range<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        vals<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> vals<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>test_max_tick_range<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> test_max_tick_range<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> test_max_tick_range<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    scores <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'MAPE'</span><span class="token punctuation">,</span> <span class="token string">'MAE'</span><span class="token punctuation">,</span> <span class="token string">'MSE'</span><span class="token punctuation">,</span> <span class="token string">'R2 Score'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        scores<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>k<span class="token punctuation">,</span> <span class="token string">'MAPE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> mape<span class="token punctuation">(</span>truths<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> preds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
        scores<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>k<span class="token punctuation">,</span> <span class="token string">'MAE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> MAE<span class="token punctuation">(</span>truths<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> preds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
        scores<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>k<span class="token punctuation">,</span> <span class="token string">'MSE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> MSE<span class="token punctuation">(</span>truths<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> preds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
        scores<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>k<span class="token punctuation">,</span> <span class="token string">'R2 Score'</span><span class="token punctuation">]</span> <span class="token operator">=</span> r2_score<span class="token punctuation">(</span>truths<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> preds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> truths<span class="token punctuation">,</span> preds<span class="token punctuation">,</span> scores</code></pre>
<p>调用该函数，并返回相应评分。</p>
<pre class="language-python" data-language="python"><code class="language-python">truths<span class="token punctuation">,</span> preds<span class="token punctuation">,</span> scores <span class="token operator">=</span> test<span class="token punctuation">(</span>params<span class="token punctuation">,</span> test_loader<span class="token punctuation">,</span> <span class="token string">'model_max.pth'</span><span class="token punctuation">)</span></code></pre>
<p>将评分进行输出。</p>
<pre class="language-python" data-language="python"><code class="language-python">scores</code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-31%2000.09.54.png"
alt="截屏2022-10-31 00.09.54" />
<figcaption aria-hidden="true">截屏2022-10-31 00.09.54</figcaption>
</figure>
<p>最后，将模型在测试集上的实际测试结果进行可视化。可视化的实现方式和第一小问当中也是基本一致的，也做了相应的平滑处理。</p>
<p>对于功率的预测：</p>
<pre class="language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>truths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
x_smth <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">)</span>
truths_smth <span class="token operator">=</span> make_interp_spline<span class="token punctuation">(</span>x<span class="token punctuation">,</span> truths<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_smth<span class="token punctuation">)</span>
preds_smth <span class="token operator">=</span> make_interp_spline<span class="token punctuation">(</span>x<span class="token punctuation">,</span> preds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_smth<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_smth<span class="token punctuation">,</span> truths_smth<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'g'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Truth'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_smth<span class="token punctuation">,</span> preds_smth<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Predict'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Q2 Daily Max Power Truth v.s. Preds on Test Dataset'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___77_0.png"
alt="results_77_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_77_0</figcaption>
</figure>
<p>对于时间的预测：</p>
<pre class="language-python" data-language="python"><code class="language-python">x <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>truths<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
x_smth <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">)</span>
truths_smth <span class="token operator">=</span> make_interp_spline<span class="token punctuation">(</span>x<span class="token punctuation">,</span> truths<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_smth<span class="token punctuation">)</span>
preds_smth <span class="token operator">=</span> make_interp_spline<span class="token punctuation">(</span>x<span class="token punctuation">,</span> preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x_smth<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_smth<span class="token punctuation">,</span> truths_smth<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'g'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Truth'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_smth<span class="token punctuation">,</span> preds_smth<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Predict'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Q2 Daily Max Time Truth v.s. Preds on Test Dataset (As Tick)'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___78_0.png"
alt="results_78_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_78_0</figcaption>
</figure>
<p>从上面两张图来看，模型基本也将整个函数是如何 “抖动”
学习的差不太多，但对于极值点和毛刺的学习不是很理想。个人分析其中的原因，这一问当中的训练数据的实际周期性不如第一小问当中那样强烈，所以在
LSTM 学习整个时序数据的过程中，对于时序这一特征的拟合不是很好。</p>
<p>另外，需要补充的一点是，模型在这一问当中的输入有 <span
class="math inline">\(85\)</span>
个特征，这可能稍微有一些过分的充足。但是，我也通过了不同的方式尝试去缩减特征维度，观察是否能够让模型效果更好。先说结论，通过缩减过特征的输入进行训练，效果并不如把
<span class="math inline">\(85\)</span> 个特征全部输入进网络当中。</p>
<p>在 <code>sklearn.feature_selection</code>
模块中，提供了一系列的函数去进行特征选择。另外，对于传统机器学习方法，也有如主成分分析（PCA）这样的方法去进行维度缩减。我这里其实进行了很多种方法的实验，由于篇幅原因这里就只举一例的实现方式。</p>
<p>这里使用的方法是，使用方差阈值的方式进行特征的选择。方差阈值的方式指的是特征的方差高于某一阈值时，才选择这一特征，否则剔除这一特征。在
<code>sklearn.feature_selection</code> 中提供了
<code>VarianceThreshold</code>
用于生成遵循这一方法的特征选择器。具体针对这一问题的实现代码如下。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword">import</span> VarianceThreshold

daily_max_data <span class="token operator">=</span> daily_max_data<span class="token punctuation">.</span>values
daily_min_data <span class="token operator">=</span> daily_min_data<span class="token punctuation">.</span>values

max_selector <span class="token operator">=</span> VarianceThreshold<span class="token punctuation">(</span>threshold<span class="token operator">=</span><span class="token number">0.16</span><span class="token punctuation">)</span>
daily_max_data <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>daily_max_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                                max_selector<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>daily_max_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

min_selector <span class="token operator">=</span> VarianceThreshold<span class="token punctuation">(</span>threshold<span class="token operator">=</span><span class="token number">0.16</span><span class="token punctuation">)</span>
daily_min_data <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>daily_min_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 min_selector<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>daily_min_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre>
<p>这里的实现过程中有一个细节需要注意。我们的因变量也是在同一张表中，虽然对于时间序列预测任务而言因变量也是输入，但我们在选择特征时不应该将因变量也纳入到选择中来，所以我这里的实现过程中使用的是不包含两个因变量的切片。</p>
<h4 id="单输出-lstm">5.2.2 单输出 LSTM</h4>
<p>这一部分简单讲就是把第一小问的过程复制粘贴了两份，但是分别调参针对不同目标进行训练。这里就不展示详细代码了，因为代码和第一小问中几乎完全一致，读者如果对代码实现感兴趣可以到我前面给出的
Kaggle Notebook 链接中查找。</p>
<p>对于功率的模型训练过程，损失图如下。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___87_0.png"
alt="results_87_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_87_0</figcaption>
</figure>
<p>输出它模型在测试集上的各项指标，得到的结果如下。</p>
<pre class="language-python" data-language="python"><code class="language-python">MAPE<span class="token punctuation">:</span> <span class="token number">24.643532931804657</span>
MAE<span class="token punctuation">:</span> <span class="token number">59966.24</span>
MSE<span class="token punctuation">:</span> <span class="token number">5366543400.0</span>
R2 Score<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">2.938622407732738</span></code></pre>
<p>可视化测试集预测结果，如图。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___90_0.png"
alt="results_90_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_90_0</figcaption>
</figure>
<p>对于时刻的训练模型，损失图像如下。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___97_0.png"
alt="results_97_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_97_0</figcaption>
</figure>
<p>测试集各项指标如下。</p>
<pre class="language-python" data-language="python"><code class="language-python">MAPE<span class="token punctuation">:</span> <span class="token number">44.9001669883728</span>
MAE<span class="token punctuation">:</span> <span class="token number">11.793661</span>
MSE<span class="token punctuation">:</span> <span class="token number">269.21896</span>
R2 Score<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">0.7501703187254463</span></code></pre>
<p>可视化测试集结果。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___100_0-20221031003314580.png"
alt="results_100_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_100_0</figcaption>
</figure>
<p>可以看到，功率预测模型的表现还是 “相对”
不错的，起码它的预测和真实数据的重合度还是较大的。但到了时刻预测模型，在上图中模型整个就没有学习到整个分布的情况。实际上，在对时刻预测模型的调参过程中，拟合的预测结果要么是抖动极小，要么是抖动极大，我没有找到一个能够使得模型能够很好学习到函数分布的一组参数。</p>
<h3 id="对每日最小值的实现">5.3 对每日最小值的实现</h3>
<p>根据 5.2 中对两种方法的实验，我最终在这一问中选择了多输出 LSTM
的方案进行训练。这里也就不把代码拿到文章里来了，整体实现除了某些变量不同外，其他基本一致。如果你感兴趣，也是可以到
Kaggle Notebook 上去查看。</p>
<p>训练模型的损失图像如图。</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___109_0.png"
alt="results_109_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_109_0</figcaption>
</figure>
<p>这一问当中，整个图像的所展示的效果就不太好了。实际上，这是我选取了众多组参数训练实验当中比较好的一个了。从图像可以明显看到，模型对于整体的数据一直处在一个过拟合的状态，但这个过拟合我没有能够通过调整超参完全消除，只能是尽可能减少过拟合的程度。或许对于这一问数据，使用
LSTM 进行训练是不够合适的。</p>
<p>从对于测试集结果的可视化也能够看出来这个问题。</p>
<p>功率预测：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___113_0.png"
alt="results_113_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_113_0</figcaption>
</figure>
<p>时间预测：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___114_0.png"
alt="results_114_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_114_0</figcaption>
</figure>
<p>要我来形容一下的话，就是模型对于整体的抖动基本学习的大差不差，但是整体的数值就出现了一个很均匀的偏移。</p>
<h2 id="问题二的实现">6 问题二的实现</h2>
<p>对于问题二的第二小问，我这里就不再进行重复了，因为这和第一问的第二小问要实现的东西是完全一致的，从模型设计思路到代码实现。这里侧重的阐述一下第一小问</p>
<h3 id="数据准备-1">6.1 数据准备</h3>
<p>首先还是读入数据。</p>
<pre class="language-python" data-language="python"><code class="language-python">cat_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../input/electrical-energy-load/train/2.csv'</span><span class="token punctuation">)</span>
cat_data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-31%2000.49.08.png" alt="截屏2022-10-31 00.49.08" style="zoom:67%;" /></p>
<p>之后也还是修改列名，同时将时间转化为 pandas 的时间类型。</p>
<pre class="language-python" data-language="python"><code class="language-python">cat_data<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Category'</span><span class="token punctuation">,</span> <span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'MaxPower'</span><span class="token punctuation">,</span> <span class="token string">'MinPower'</span><span class="token punctuation">]</span>
cat_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>cat_data<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>查看行业类型，一共有四种行业。</p>
<pre class="language-python" data-language="python"><code class="language-python">cat_data<span class="token punctuation">[</span><span class="token string">'Category'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<pre class="language-python" data-language="python"><code class="language-python">大工业用电    <span class="token number">973</span>
普通工业     <span class="token number">973</span>
商业       <span class="token number">973</span>
非普工业     <span class="token number">691</span>
Name<span class="token punctuation">:</span> Category<span class="token punctuation">,</span> dtype<span class="token punctuation">:</span> int64</code></pre>
<p>按行业对数据进行分组，对每一种行业按照时间频度为一天进行时间补全。同时，使用插值方法对功率数据进行填充。最后，分别将每个行业的数据进行可视化。</p>
<pre class="language-python" data-language="python"><code class="language-python">groups <span class="token operator">=</span> cat_data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Category'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
all_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Category'</span><span class="token punctuation">,</span> <span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'MaxPower'</span><span class="token punctuation">,</span> <span class="token string">'MinPower'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> group <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>groups<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x<span class="token punctuation">,</span> y <span class="token operator">=</span> i <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> i <span class="token operator">%</span> <span class="token number">2</span>
    category<span class="token punctuation">,</span> df <span class="token operator">=</span> group
    grouper <span class="token operator">=</span> pd<span class="token punctuation">.</span>Grouper<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">'Date'</span><span class="token punctuation">,</span> freq<span class="token operator">=</span><span class="token string">'D'</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>grouper<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Category'</span><span class="token punctuation">,</span> <span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'MaxPower'</span><span class="token punctuation">,</span> <span class="token string">'MinPower'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    all_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>all_data<span class="token punctuation">,</span> res<span class="token punctuation">]</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    res<span class="token punctuation">[</span><span class="token string">'MaxPower'</span><span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token string">'MaxPower'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">[</span><span class="token string">'MinPower'</span><span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token string">'MinPower'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>interpolate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>category<span class="token punctuation">&#125;</span></span><span class="token string">.csv'</span></span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    sns<span class="token punctuation">.</span>lineplot<span class="token punctuation">(</span>data<span class="token operator">=</span>res<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'MaxPower'</span><span class="token punctuation">,</span> <span class="token string">'MinPower'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>axes<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span>
all_data<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'处理后数据.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___118_0.png"
alt="results_118_0" />
<figcaption
aria-hidden="true"><strong>results</strong>_118_0</figcaption>
</figure>
<h3 id="突变点分析">6.2 突变点分析</h3>
<p>对于时间序列的突变点分析，有很多种成熟的方法。对于一般序列，可以使用
MK 检验、Pettitt 方法、滑动 T
检验等一系列方法，也有一些针对非平稳序列的启发式检测算法，如 BG
切割算法等。我这里使用的是 MK 检验进行。</p>
<p>参照网上博客的代码稍加修改，实现了如下的 MK
检验函数。该函数将时间序列数据作为输入，以列表形式返回时间序列当中的突变点。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">MK</span><span class="token punctuation">(</span>inputdata<span class="token punctuation">)</span><span class="token punctuation">:</span>
    inputdata <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>inputdata<span class="token punctuation">)</span>
    n<span class="token operator">=</span>inputdata<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 正序列计算---------------------------------</span>
    <span class="token comment"># 定义累计量序列Sk，初始值=0</span>
    Sk             <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 定义统计量UFk，初始值 =0</span>
    UFk            <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 定义Sk序列元素s，初始值 =0</span>
    s              <span class="token operator">=</span>  <span class="token number">0</span>
    Exp_value      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    Var_value      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># i从1开始，因为根据统计量UFk公式，i=0时，Sk(0)、E(0)、Var(0)均为0</span>
    <span class="token comment"># 此时UFk无意义，因此公式中，令UFk(0)=0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> inputdata<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> inputdata<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                s <span class="token operator">=</span> s<span class="token operator">+</span><span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                s <span class="token operator">=</span> s<span class="token operator">+</span><span class="token number">0</span>
        Sk<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        Exp_value<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span> <span class="token punctuation">)</span>                     <span class="token comment"># Sk[i]的均值</span>
        Var_value<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>i<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">72</span> <span class="token punctuation">)</span>            <span class="token comment"># Sk[i]的方差</span>
        UFk<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>Sk<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span>Exp_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>Var_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># ------------------------------正序列计算</span>
    <span class="token comment"># 逆序列计算---------------------------------</span>
    <span class="token comment"># 定义逆序累计量序列Sk2，长度与inputdata一致，初始值=0</span>
    Sk2             <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 定义逆序统计量UBk，长度与inputdata一致，初始值=0</span>
    UBk             <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    UBk2            <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># s归0</span>
    s2              <span class="token operator">=</span>  <span class="token number">0</span>
    Exp_value2      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    Var_value2      <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 按时间序列逆转样本y</span>
    inputdataT <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span>inputdata<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># i从2开始，因为根据统计量UBk公式，i=1时，Sk2(1)、E(1)、Var(1)均为0</span>
    <span class="token comment"># 此时UBk无意义，因此公式中，令UBk(1)=0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> inputdataT<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> inputdataT<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                s2 <span class="token operator">=</span> s2<span class="token operator">+</span><span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                s2 <span class="token operator">=</span> s2<span class="token operator">+</span><span class="token number">0</span>
        Sk2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
        Exp_value2<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span> <span class="token punctuation">)</span>                     <span class="token comment"># Sk[i]的均值</span>
        Var_value2<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>i<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">72</span> <span class="token punctuation">)</span>            <span class="token comment"># Sk[i]的方差</span>
        UBk<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>Sk2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span>Exp_value2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>Var_value2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        UBk2<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token operator">-</span>UBk<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 由于对逆序序列的累计量Sk2的构建中，依然用的是累加法，即后者大于前者时s加1，</span>
    <span class="token comment"># 则s的大小表征了一种上升的趋势的大小，而序列逆序以后，应当表现出与原序列相反</span>
    <span class="token comment"># 的趋势表现，因此，用累加法统计Sk2序列，统计量公式(S(i)-E(i))/sqrt(Var(i))</span>
    <span class="token comment">#也不应改变，但统计量UBk应取相反数以表征正确的逆序序列的趋势</span>
    <span class="token comment">#  UBk(i)=0-(Sk2(i)-E)/sqrt(Var)</span>
    <span class="token comment"># ------------------------------逆序列计算</span>
    <span class="token comment"># 此时上一步的到UBk表现的是逆序列在逆序时间上的趋势统计量</span>
    <span class="token comment"># 与UFk做图寻找突变点时，2条曲线应具有同样的时间轴，因此</span>
    <span class="token comment"># 再按时间序列逆转结果统计量UBk，得到时间正序的UBkT，</span>
    UBkT <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">reversed</span><span class="token punctuation">(</span>UBk2<span class="token punctuation">)</span><span class="token punctuation">)</span>
    diff <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>UFk<span class="token punctuation">)</span> <span class="token operator">-</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>UBkT<span class="token punctuation">)</span>
    K    <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 找出交叉点</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> diff<span class="token punctuation">[</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>diff<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">:</span>
            K<span class="token punctuation">.</span>append<span class="token punctuation">(</span>k<span class="token punctuation">)</span>
    <span class="token comment"># 做突变检测图时，使用UFk和UBkT</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>UFk  <span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'UFk'</span><span class="token punctuation">)</span> <span class="token comment"># UFk</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>UBkT <span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'UBk'</span><span class="token punctuation">)</span> <span class="token comment"># UBk</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'UFk-UBk Graph'</span><span class="token punctuation">)</span>
    x_lim <span class="token operator">=</span> plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_lim<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.96</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1.96</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'m--'</span><span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_lim<span class="token punctuation">,</span><span class="token punctuation">[</span>  <span class="token number">0</span>  <span class="token punctuation">,</span>  <span class="token number">0</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'m--'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x_lim<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token number">1.96</span><span class="token punctuation">,</span><span class="token operator">+</span><span class="token number">1.96</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'m--'</span><span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 图例</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'UFk-UBk'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> K</code></pre>
<p>使用这一方法，分别对四个行业的最大值、最小值进行分析。实现代码如下。</p>
<pre class="language-python" data-language="python"><code class="language-python">categories <span class="token operator">=</span> all_data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Category'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> as_index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> category <span class="token keyword">in</span> categories<span class="token punctuation">:</span>
    name<span class="token punctuation">,</span> df <span class="token operator">=</span> category
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'==================</span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string">===================='</span></span><span class="token punctuation">)</span>
    maxMK<span class="token punctuation">,</span> minMK <span class="token operator">=</span> MK<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'MaxPower'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MK<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'MinPower'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Category </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> max:'</span></span><span class="token punctuation">,</span> maxMK<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Category </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> min:'</span></span><span class="token punctuation">,</span> minMK<span class="token punctuation">)</span>
    
    min_date <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'MaxPower'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'deepskyblue'</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>maxMK<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'MaxPower'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>maxMK<span class="token punctuation">,</span> y<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'*'</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> zorder<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        px <span class="token operator">=</span> maxMK<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        py <span class="token operator">=</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        cur_date <span class="token operator">=</span> min_date <span class="token operator">+</span> pd<span class="token punctuation">.</span>Timedelta<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>px<span class="token punctuation">&#125;</span></span><span class="token string">D'</span></span><span class="token punctuation">)</span>
        yy<span class="token punctuation">,</span> m<span class="token punctuation">,</span> d <span class="token operator">=</span> cur_date<span class="token punctuation">.</span>year<span class="token punctuation">,</span> cur_date<span class="token punctuation">.</span>month<span class="token punctuation">,</span> cur_date<span class="token punctuation">.</span>day
        label <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>yy<span class="token punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">&#123;</span>m<span class="token punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">&#123;</span>d<span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>py<span class="token punctuation">&#125;</span></span><span class="token string">)'</span></span>
        plt<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>label<span class="token punctuation">,</span> <span class="token punctuation">(</span>px<span class="token punctuation">,</span> py<span class="token punctuation">)</span><span class="token punctuation">,</span> rotation<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Max Power'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> df<span class="token punctuation">[</span><span class="token string">'MinPower'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'deepskyblue'</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>minMK<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'MinPower'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>minMK<span class="token punctuation">,</span> y<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'*'</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> zorder<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>minMK<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        px <span class="token operator">=</span> minMK<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        py <span class="token operator">=</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        cur_date <span class="token operator">=</span> min_date <span class="token operator">+</span> pd<span class="token punctuation">.</span>Timedelta<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>px<span class="token punctuation">&#125;</span></span><span class="token string">D'</span></span><span class="token punctuation">)</span>
        yy<span class="token punctuation">,</span> m<span class="token punctuation">,</span> d <span class="token operator">=</span> cur_date<span class="token punctuation">.</span>year<span class="token punctuation">,</span> cur_date<span class="token punctuation">.</span>month<span class="token punctuation">,</span> cur_date<span class="token punctuation">.</span>day
        label <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>yy<span class="token punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">&#123;</span>m<span class="token punctuation">&#125;</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">&#123;</span>d<span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span>py<span class="token punctuation">&#125;</span></span><span class="token string">)'</span></span>
        plt<span class="token punctuation">.</span>annotate<span class="token punctuation">(</span>label<span class="token punctuation">,</span> <span class="token punctuation">(</span>px<span class="token punctuation">,</span> py<span class="token punctuation">)</span><span class="token punctuation">,</span> rotation<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Min Power'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>对于每个行业，前两张图分别将 UFk 和 UBk
进行了可视化，后两张图分别对于最大、最小功率的突变点进行了可视化，在图中用星号标注了突变点，并标记了其突变时间和当前功率值。</p>
<p>商业：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_2.png"
alt="results_122_2" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_2</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_3.png"
alt="results_122_3" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_3</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_5.png"
alt="results_122_5" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_5</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_6.png"
alt="results_122_6" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_6</figcaption>
</figure>
<p>大工业用电：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_8.png"
alt="results_122_8" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_8</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_9.png"
alt="results_122_9" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_9</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_11.png"
alt="results_122_11" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_11</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_12.png"
alt="results_122_12" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_12</figcaption>
</figure>
<p>普通工业：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_14.png"
alt="results_122_14" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_14</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_15.png"
alt="results_122_15" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_15</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_17.png"
alt="results_122_17" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_17</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_18.png"
alt="results_122_18" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_18</figcaption>
</figure>
<p>非普工业：</p>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_20.png"
alt="results_122_20" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_20</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_21.png"
alt="results_122_21" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_21</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_23.png"
alt="results_122_23" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_23</figcaption>
</figure>
<figure>
<img
src="https://leolang-blog-pictures.oss-cn-beijing.aliyuncs.com/img/__results___122_24.png"
alt="results_122_24" />
<figcaption
aria-hidden="true"><strong>results</strong>_122_24</figcaption>
</figure>
<h2 id="实验总结">7 实验总结</h2>
<p>本次实验主要针对的问题是时间序列分析问题，通过本次实验，了解了常用的时间序列分析方法，并且通过神经网络的搭建、训练、调参等过程，也加深了对于神经网络的理解，使得搭建神经网络面对不同问题能够更加熟练。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>LeoLang
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://www.leolang.top/2022/10/31/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2007/" title="数据分析实验 07">https://www.leolang.top/2022/10/31/数据分析实验 07/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a>
              <a href="/tags/Data-Analysis/" rel="tag"><i class="fa fa-tag"></i> Data Analysis</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/10/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%2006/" rel="prev" title="数据分析实验 06">
                  <i class="fa fa-chevron-left"></i> 数据分析实验 06
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="SOHUCS"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LeoLang</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">433k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">6:34</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>



  <script class="next-config" data-name="nprogress" type="application/json">{"enable":true,"spinner":true}</script>
  <script src="/js/third-party/nprogress.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"41UWIC7MMp6zIfeLwJ9NYyGs-gzGzoHsz","app_key":"ITEb4maRYOsE2d4OazXV9neM","server_url":"https://41uwic7m.lc-cn-n1-shared.com","security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyvB8TI3f","appkey":"73c618e7e6297e7a69f0c1377f03ffc4"}</script>
<script src="/js/third-party/comments/changyan.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModePath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"positon":"right","width":150,"height":300},"mobile":false,"log":false,"pluginModelPath":"assets/"});</script></body>
</html>
